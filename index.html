<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Life Dashboard</title>
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWVybyBKaXZhbiIsInNob3J0X25hbWUiOiJNZXJvIEppdmFuIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjMDY4OTBhIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzEyOHgzMjgvMDY4OTBhL0ZGRiIsInNpemVzIjoiMTI4eDEyOCJ9XX0=">
    <meta name="theme-color" content="#06890a">
    <!-- NOTIFICATION PERMISSION -->
    <script>if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyCwQVdSe_BvFgxwXd4oP6PPOuh6NrJaXNY",
        authDomain: "mero-jivan-cd3a6.firebaseapp.com",
        databaseURL: "https://mero-jivan-cd3a6-default-rtdb.firebaseio.com",
        projectId: "mero-jivan-cd3a6",
        storageBucket: "mero-jivan-cd3a6.firebasestorage.app",
        messagingSenderId: "244728705595",
        appId: "1:244728705595:web:dddc0a53d7cae21bbba21e",
        measurementId: "G-3RVXWQMYTL"
      };

      // Initialize Firebase
      let auth, database;
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        auth = firebase.auth();
        database = firebase.database();
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.error('Firebase initialization failed:', error);
      }

      // --- ICONS (as SVG components) ---
      const MoneyIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>);
      const LifeIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>);
      const GrowIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>);
      const AccountIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>);
      const PlusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>);
      const MinusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" /></svg>);
      const FoodIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>);
      const TransportIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>);
      const BillsIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>);
      const ShoppingIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>);
      const FunIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
      const HealthIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>);
      const OtherIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg>);
      const SalaryIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>);
      const GiftIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>);
      const BackArrowIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>);
      const EditIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>);
      const GoogleIcon = () => (<svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>);

      // --- DATA & HELPERS ---
      const CATEGORIES = { expense: [{ id: 'food', name: 'Food', Icon: FoodIcon, color: '#FF6384' },{ id: 'transport', name: 'Transport', Icon: TransportIcon, color: '#36A2EB' },{ id: 'home', name: 'Home', Icon: OtherIcon, color: '#FFCE56' },{ id: 'bills', name: 'Bills', Icon: BillsIcon, color: '#4BC0C0' },{ id: 'shopping', name: 'Shopping', Icon: ShoppingIcon, color: '#9966FF' },{ id: 'fun', name: 'Fun', Icon: FunIcon, color: '#FF9F40' },{ id: 'health', name: 'Health', Icon: HealthIcon, color: '#E83E8C' },{ id: 'other_expense', name: 'Other', Icon: OtherIcon, color: '#6C757D' }], income: [{ id: 'salary', name: 'Salary', Icon: SalaryIcon },{ id: 'gift', name: 'Gift', Icon: GiftIcon },{ id: 'other_income', name: 'Other', Icon: OtherIcon }] };
      const ALL_CATEGORIES = [...CATEGORIES.expense, ...CATEGORIES.income].reduce((acc, cat) => { acc[cat.id] = cat; return acc; }, {});
      const NEPALI_MONTH_DATA = { 2070: [30, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2071: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2072: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2073: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2074: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2075: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2076: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2077: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2078: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2079: [31, 31, 32, 32, 31, 30, 29, 30, 29, 30, 29, 31], 2080: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2081: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2082: [30, 32, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2083: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2084: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2085: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2086: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2087: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2088: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2089: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2090: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30] };
      const NEPALI_MONTHS = ['Baishakh','Jestha','Ashadh','Shrawan','Bhadra','Ashwin','Kartik','Mangsir','Poush','Magh','Falgun','Chaitra'];
      const NEPALI_YEAR_START_GREGORIAN_DATE = { 2070: '2013-04-14', 2071: '2014-04-14', 2072: '2015-04-14', 2073: '2016-04-13', 2074: '2017-04-14', 2075: '2018-04-14', 2076: '2019-04-14', 2077: '2020-04-13', 2078: '2021-04-14', 2079: '2022-04-14', 2080: '2023-04-14', 2081: '2024-04-13', 2082: '2025-04-14', 2083: '2026-04-14', 2084: '2027-04-14', 2085: '2028-04-13', 2086: '2029-04-14', 2087: '2030-04-14', 2088: '2031-04-14', 2089: '2032-04-13', 2090: '2033-04-14' };
      const gregorianToNepali = (gregorianDate) => { const defaultDate = { year: 2081, month: 1, day: 1, monthName: 'Baishakh' }; if (!gregorianDate) return defaultDate; const inputDate = new Date(gregorianDate); inputDate.setUTCHours(0, 0, 0, 0); let nepaliYear; const sortedYears = Object.keys(NEPALI_YEAR_START_GREGORIAN_DATE).sort((a, b) => b - a); for (const year of sortedYears) { const startDate = new Date(NEPALI_YEAR_START_GREGORIAN_DATE[year]); startDate.setUTCHours(0, 0, 0, 0); if (inputDate >= startDate) { nepaliYear = parseInt(year); break; } } if (!nepaliYear) return defaultDate; const nepaliYearStartDate = new Date(NEPALI_YEAR_START_GREGORIAN_DATE[nepaliYear]); nepaliYearStartDate.setUTCHours(0, 0, 0, 0); const dayDiff = Math.round((inputDate - nepaliYearStartDate) / (1000 * 60 * 60 * 24)); let nepaliMonth = 1, nepaliDay = dayDiff + 1; const monthDaysData = NEPALI_MONTH_DATA[nepaliYear]; if (!monthDaysData) return defaultDate; for (let i = 0; i < monthDaysData.length; i++) { const daysInMonth = monthDaysData[i]; if (nepaliDay <= daysInMonth) break; else { nepaliDay -= daysInMonth; nepaliMonth++; } } return { year: nepaliYear, month: nepaliMonth, day: nepaliDay, monthName: NEPALI_MONTHS[nepaliMonth - 1] }; };
      const nepaliToGregorian = (nepaliYear, nepaliMonth, nepaliDay) => { const gregorianStartDateStr = NEPALI_YEAR_START_GREGORIAN_DATE[nepaliYear]; if (!gregorianStartDateStr) return new Date().toISOString().split('T')[0]; const gregorianStartDate = new Date(gregorianStartDateStr); let daysToAdd = 0; const monthData = NEPALI_MONTH_DATA[nepaliYear]; if (!monthData) return new Date().toISOString().split('T')[0]; for (let i = 0; i < nepaliMonth - 1; i++) { daysToAdd += monthData[i]; } daysToAdd += nepaliDay - 1; const resultDate = new Date(gregorianStartDate.getTime()); resultDate.setDate(gregorianStartDate.getDate() + daysToAdd); return resultDate.toISOString().split('T')[0]; };
      
      // ENHANCED WORKOUT DATA WITH REAL EXERCISES
      const WORKOUT_DATA = {
          'Chest': [
              { 
                  id: 1, 
                  name: 'Barbell Bench Press', 
                  description: 'Lie on a flat bench with feet firmly on the ground. Grip barbell slightly wider than shoulder width. Lower bar to chest, then press back up explosively.',
                  gif: 'https://media.giphy.com/media/l1J9HWBKLp20YOXrW/giphy.gif',
                  equipment: 'Barbell, Bench',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 2, 
                  name: 'Incline Dumbbell Press', 
                  description: 'Lie on incline bench (30-45 degrees). Press dumbbells upward until arms are extended. Lower with control to chest level.',
                  gif: 'https://media.giphy.com/media/3o72FfM5HJydzafgUE/giphy.gif',
                  equipment: 'Dumbbells, Incline Bench',
                  difficulty: 'Beginner'
              },
              { 
                  id: 3, 
                  name: 'Cable Crossover', 
                  description: 'Stand between cable machine with handles set high. Pull cables downward and across body in a wide arc, squeezing chest.',
                  gif: 'https://media.giphy.com/media/3o7TKSjVa1aPchLJxS/giphy.gif',
                  equipment: 'Cable Machine',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 4, 
                  name: 'Push-ups', 
                  description: 'Start in plank position. Lower body until chest nearly touches floor, keeping elbows close to body. Push back up to start.',
                  gif: 'https://media.giphy.com/media/13HOBYXe87LjvW/giphy.gif',
                  equipment: 'Bodyweight',
                  difficulty: 'Beginner'
              }
          ],
          'Back': [
              { 
                  id: 5, 
                  name: 'Pull-ups', 
                  description: 'Hang from bar with overhand grip. Pull body up until chin is above bar. Lower with control back to starting position.',
                  gif: 'https://media.giphy.com/media/l0HlGMc2uC27OqFfW/giphy.gif',
                  equipment: 'Pull-up Bar',
                  difficulty: 'Advanced'
              },
              { 
                  id: 6, 
                  name: 'Bent Over Barbell Row', 
                  description: 'Stand with feet shoulder-width apart, bend knees slightly. Hinge at hips until torso is nearly parallel to floor. Pull barbell to lower chest.',
                  gif: 'https://media.giphy.com/media/3o7TKr1Z5W7P3YaKec/giphy.gif',
                  equipment: 'Barbell',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 7, 
                  name: 'Lat Pulldown', 
                  description: 'Sit at lat pulldown machine with knees secured. Grip bar wide, pull down to upper chest while leaning back slightly.',
                  gif: 'https://media.giphy.com/media/l0HlGMc2uC27OqFfW/giphy.gif',
                  equipment: 'Cable Machine',
                  difficulty: 'Beginner'
              },
              { 
                  id: 8, 
                  name: 'Seated Cable Row', 
                  description: 'Sit at cable row machine with feet braced. Pull handle to abdomen while keeping back straight. Squeeze shoulder blades together.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Cable Machine',
                  difficulty: 'Beginner'
              }
          ],
          'Shoulders': [
              { 
                  id: 9, 
                  name: 'Overhead Press', 
                  description: 'Stand with barbell at shoulder level. Press barbell overhead until arms are fully extended. Lower with control.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Barbell',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 10, 
                  name: 'Dumbbell Lateral Raise', 
                  description: 'Stand holding dumbbells at sides. Raise arms out to sides until parallel with floor. Lower with control.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Dumbbells',
                  difficulty: 'Beginner'
              },
              { 
                  id: 11, 
                  name: 'Face Pulls', 
                  description: 'Set cable at upper level. Pull rope towards face, separating hands to sides of head. Focus on rear deltoids.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Cable Machine',
                  difficulty: 'Beginner'
              }
          ],
          'Biceps': [
              { 
                  id: 12, 
                  name: 'Barbell Curl', 
                  description: 'Stand holding barbell with underhand grip. Curl weight up to shoulder level while keeping elbows stationary.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Barbell',
                  difficulty: 'Beginner'
              },
              { 
                  id: 13, 
                  name: 'Hammer Curl', 
                  description: 'Hold dumbbells with neutral grip (palms facing each other). Curl weights up while maintaining grip position.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Dumbbells',
                  difficulty: 'Beginner'
              },
              { 
                  id: 14, 
                  name: 'Concentration Curl', 
                  description: 'Sit on bench, rest elbow against inner thigh. Curl dumbbell up in isolated motion for peak contraction.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Dumbbell, Bench',
                  difficulty: 'Beginner'
              }
          ],
          'Triceps': [
              { 
                  id: 15, 
                  name: 'Tricep Pushdown', 
                  description: 'Stand at cable machine with rope attachment. Push rope down until arms are fully extended. Focus on tricep contraction.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Cable Machine',
                  difficulty: 'Beginner'
              },
              { 
                  id: 16, 
                  name: 'Close Grip Bench Press', 
                  description: 'Similar to bench press but with hands closer together. This emphasizes tricep involvement in the pressing motion.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Barbell, Bench',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 17, 
                  name: 'Overhead Tricep Extension', 
                  description: 'Sit or stand holding dumbbell with both hands overhead. Lower weight behind head, then extend arms back up.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Dumbbell',
                  difficulty: 'Beginner'
              }
          ],
          'Abs': [
              { 
                  id: 18, 
                  name: 'Cable Crunch', 
                  description: 'Kneel below cable machine with rope attachment. Crunch downward, contracting abs fully. Return with control.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Cable Machine',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 19, 
                  name: 'Hanging Leg Raise', 
                  description: 'Hang from pull-up bar. Raise legs until parallel with floor or higher. Lower with control without swinging.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Pull-up Bar',
                  difficulty: 'Advanced'
              },
              { 
                  id: 20, 
                  name: 'Russian Twists', 
                  description: 'Sit on floor with knees bent. Lean back slightly and twist torso side to side while holding weight.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Weight (optional)',
                  difficulty: 'Beginner'
              }
          ],
          'Quads': [
              { 
                  id: 21, 
                  name: 'Barbell Squat', 
                  description: 'Stand with barbell across upper back. Lower hips as if sitting in chair until thighs are parallel to floor. Drive back up.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Barbell',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 22, 
                  name: 'Leg Press', 
                  description: 'Sit in leg press machine with feet shoulder-width apart. Press platform away, then return with control.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Leg Press Machine',
                  difficulty: 'Beginner'
              },
              { 
                  id: 23, 
                  name: 'Leg Extensions', 
                  description: 'Sit in leg extension machine. Extend legs until they are straight, squeezing quads. Lower with control.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Leg Extension Machine',
                  difficulty: 'Beginner'
              }
          ],
          'Hamstrings': [
              { 
                  id: 24, 
                  name: 'Romanian Deadlift', 
                  description: 'Stand holding barbell. Hinge at hips while keeping legs relatively straight. Lower barbell until stretch in hamstrings.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Barbell',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 25, 
                  name: 'Lying Leg Curl', 
                  description: 'Lie face down on leg curl machine. Curl legs up towards glutes, squeezing hamstrings. Lower with control.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Leg Curl Machine',
                  difficulty: 'Beginner'
              }
          ],
          'Calves': [
              { 
                  id: 26, 
                  name: 'Standing Calf Raise', 
                  description: 'Stand on raised surface with heels hanging off. Raise up on toes as high as possible, then lower heels below platform.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Calf Raise Machine or Bodyweight',
                  difficulty: 'Beginner'
              }
          ],
          'Glutes': [
              { 
                  id: 27, 
                  name: 'Hip Thrust', 
                  description: 'Sit on floor with upper back against bench. Place barbell across hips. Thrust hips upward until body forms straight line.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Barbell, Bench',
                  difficulty: 'Intermediate'
              },
              { 
                  id: 28, 
                  name: 'Glute Bridge', 
                  description: 'Lie on back with knees bent. Lift hips off floor until body forms straight line from shoulders to knees.',
                  gif: 'https://media.giphy.com/media/3o7TKsQ7UQ13gbji2A/giphy.gif',
                  equipment: 'Bodyweight',
                  difficulty: 'Beginner'
              }
          ]
      };

      // --- FIXED CLOUD SYNC FUNCTIONS ---
      const syncDataToCloud = async (userId, data) => {
        try {
          if (database && userId && userId !== 'local') {
            console.log('🔄 Syncing data to cloud for user:', userId);
            await database.ref(`users/${userId}`).set({
              transactions: data.transactions || [],
              todos: data.todos || [],
              toBuy: data.toBuy || [],
              lendBorrow: data.lendBorrow || [],
              settings: data.settings || {},
              lastSync: new Date().toISOString()
            });
            console.log('✅ Data successfully synced to cloud');
            return true;
          } else {
            console.log('⏭️ Cloud sync skipped - no database or local user');
            return false;
          }
        } catch (error) {
          console.error('❌ Error syncing to cloud:', error);
          return false;
        }
      };

      const loadDataFromCloud = async (userId) => {
        try {
          if (database && userId && userId !== 'local') {
            console.log('📥 Loading data from cloud for user:', userId);
            const snapshot = await database.ref(`users/${userId}`).once('value');
            const cloudData = snapshot.val();
            
            if (cloudData) {
              console.log('✅ Cloud data loaded successfully');
              return {
                transactions: cloudData.transactions || [],
                todos: cloudData.todos || [],
                toBuy: cloudData.toBuy || [],
                lendBorrow: cloudData.lendBorrow || [],
                settings: cloudData.settings || {}
              };
            } else {
              console.log('ℹ️ No cloud data found for user');
              return null;
            }
          }
        } catch (error) {
          console.error('❌ Error loading from cloud:', error);
        }
        return null;
      };

      // --- CHILD COMPONENTS ---
      const PieChart = ({ data }) => {
          const size = 192; const donutThickness = 24; const center = size / 2; const radius = center - (donutThickness / 2); if (!data || data.length === 0) return null; const total = data.reduce((sum, item) => sum + item.value, 0); if (total === 0) return null; let cumulativePercent = 0;
          const segments = data.map((item, index) => { const percent = item.value / total; const getCoordinatesForPercent = (p) => [center + radius * Math.cos(2 * Math.PI * p), center + radius * Math.sin(2 * Math.PI * p)]; const [startX, startY] = getCoordinatesForPercent(cumulativePercent); cumulativePercent += percent; const [endX, endY] = getCoordinatesForPercent(cumulativePercent); const largeArcFlag = percent > 0.5 ? 1 : 0; const pathData = `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`; return <path key={index} d={pathData} fill="none" stroke={item.color} strokeWidth={donutThickness} />; });
          return (<div className="relative w-48 h-48 mx-auto flex items-center justify-center"><svg viewBox={`0 0 ${size} ${size}`} className="transform -rotate-90">{segments}</svg><div className="absolute text-center"><p className="text-xs text-gray-500 dark:text-gray-400">Total Spent</p><p className="font-bold text-xl text-gray-800 dark:text-gray-200">रु {total.toLocaleString('en-NP')}</p></div></div>);
      };
      
      const NepaliDatePicker = ({ gregorianDate, setGregorianDate, onClose }) => { 
        const [currentNepaliDate, setCurrentNepaliDate] = useState(() => gregorianToNepali(gregorianDate)); 
        const changeMonth = (delta) => { 
          let newMonth = currentNepaliDate.month + delta; 
          let newYear = currentNepaliDate.year; 
          if (newMonth > 12) { newMonth = 1; newYear++; } 
          else if (newMonth < 1) { newMonth = 12; newYear--; } 
          if (NEPALI_MONTH_DATA[newYear]) { 
            setCurrentNepaliDate({ year: newYear, month: newMonth, day: 1 }); 
          } 
        }; 
        const daysInMonth = NEPALI_MONTH_DATA[currentNepaliDate.year]?.[currentNepaliDate.month - 1] || 30; 
        const firstDayOfMonthGregorian = nepaliToGregorian(currentNepaliDate.year, currentNepaliDate.month, 1); 
        const firstDayOfWeek = new Date(firstDayOfMonthGregorian).getDay(); 
        const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1); 
        const blanks = Array(firstDayOfWeek).fill(null); 
        return ( 
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50" onClick={onClose}> 
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 w-80" onClick={e => e.stopPropagation()}> 
              <div className="flex justify-between items-center mb-4"> 
                <button onClick={() => changeMonth(-1)} className="font-bold text-lg p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white">&lt;</button> 
                <div> 
                  <span className="font-bold text-lg dark:text-white">{NEPALI_MONTHS[currentNepaliDate.month - 1]}</span> 
                  <span className="text-lg ml-2 dark:text-gray-300">{currentNepaliDate.year}</span> 
                </div> 
                <button onClick={() => changeMonth(1)} className="font-bold text-lg p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white">&gt;</button> 
              </div> 
              <div className="grid grid-cols-7 gap-1 text-center text-sm"> 
                <div className="font-semibold text-gray-500 dark:text-gray-400">Sun</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Mon</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Tue</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Wed</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Thu</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Fri</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Sat</div> 
                {blanks.map((_, i) => <div key={`blank-${i}`}></div>)} 
                {daysArray.map(day => { 
                  const isSelected = gregorianToNepali(gregorianDate).day === day && gregorianToNepali(gregorianDate).month === currentNepaliDate.month && gregorianToNepali(gregorianDate).year === currentNepaliDate.year; 
                  return ( 
                    <div key={day} onClick={() => { setGregorianDate(nepaliToGregorian(currentNepaliDate.year, currentNepaliDate.month, day)); onClose(); }} className={`p-2 rounded-full cursor-pointer dark:text-white ${isSelected ? 'bg-teal-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`}> 
                      {day} 
                    </div> 
                  ); 
                })} 
              </div> 
            </div> 
          </div> 
        ); 
      };
      
      const AddTransactionModal = ({ isOpen, onClose, addTransaction, initialType }) => { 
        const [type, setType] = useState(initialType); 
        const [amount, setAmount] = useState(''); 
        const [description, setDescription] = useState(''); 
        const [categoryId, setCategoryId] = useState(''); 
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]); 
        const [isDatePickerOpen, setIsDatePickerOpen] = useState(false); 
        
        useEffect(() => { 
          setType(initialType); 
          setAmount(''); 
          setDescription(''); 
          setCategoryId(CATEGORIES[initialType][0].id); 
        }, [isOpen, initialType]); 
        
        if (!isOpen) return null; 
        
        const handleSubmit = (e) => { 
          e.preventDefault(); 
          if (!amount || !categoryId) return; 
          addTransaction({ type, amount: parseFloat(amount), description, categoryId, date }); 
        }; 
        
        const nepaliDate = gregorianToNepali(date); 
        
        return ( 
          <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40"> 
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md m-4"> 
              <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">{type === 'income' ? 'Add Income' : 'Add Expense'}</h2> 
              <form onSubmit={handleSubmit}> 
                <div className="mb-4"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Amount</label> 
                  <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline" placeholder="रु 0.00" required /> 
                </div> 
                <div className="mb-4"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Category</label> 
                  <div className="grid grid-cols-4 gap-2"> 
                    {CATEGORIES[type].map(cat => ( 
                      <button type="button" key={cat.id} onClick={() => setCategoryId(cat.id)} className={`p-2 rounded-lg border-2 ${categoryId === cat.id ? 'border-teal-500 bg-teal-50 dark:bg-teal-900/50' : 'border-gray-200 dark:border-gray-600'} flex flex-col items-center text-gray-700 dark:text-gray-300`}> 
                        <cat.Icon /> 
                        <span className="text-xs mt-1">{cat.name}</span> 
                      </button> 
                    ))} 
                  </div> 
                </div> 
                <div className="mb-4"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Description</label> 
                  <input type="text" value={description} onChange={e => setDescription(e.target.value)} className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" placeholder="e.g., Lunch with friends" /> 
                </div> 
                <div className="mb-6"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Date</label> 
                  <button type="button" onClick={() => setIsDatePickerOpen(true)} className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-left">{nepaliDate.day} {nepaliDate.monthName}, {nepaliDate.year}</button> 
                </div> 
                <div className="flex items-center justify-between"> 
                  <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg">Cancel</button> 
                  <button type="submit" className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Save</button> 
                </div> 
              </form> 
              {isDatePickerOpen && <NepaliDatePicker gregorianDate={date} setGregorianDate={setDate} onClose={() => setIsDatePickerOpen(false)} />} 
            </div> 
          </div> 
        ); 
      };
      
      // FIXED TODO LIST - Tasks only appear in their created period
      const ToDoList = ({ todos, setTodos }) => { 
          const [newTodoText, setNewTodoText] = useState(''); 
          const [newTodoPriority, setNewTodoPriority] = useState('medium'); 
          const [activeTab, setActiveTab] = useState('today'); 
          const [showCompleted, setShowCompleted] = useState(false);
          
          // Filter todos based on active tab and completion status
          const filteredTodos = useMemo(() => {
            // Only show todos that were created for this specific period
            let filtered = todos.filter(todo => todo.period === activeTab);

            // Separate completed and incomplete
            const incomplete = filtered.filter(todo => !todo.completed);
            const completed = filtered.filter(todo => todo.completed);

            return showCompleted ? completed : incomplete;
          }, [todos, activeTab, showCompleted]);

          const addTodo = (e) => { 
            e.preventDefault(); 
            if (newTodoText.trim() === '') return; 
            const newTodo = { 
              id: Date.now(), 
              text: newTodoText, 
              priority: newTodoPriority, 
              completed: false, 
              createdAt: new Date().toISOString(),
              period: activeTab // Store which period this task belongs to
            };
            setTodos(prev => [newTodo, ...prev]); 
            setNewTodoText(''); 
            setNewTodoPriority('medium'); 
          }; 

          const toggleTodo = (id) => { 
            setTodos(prev => prev.map(t => t.id === id ? { ...t, completed: !t.completed } : t)); 
          }; 

          const deleteTodo = (id) => { 
            setTodos(prev => prev.filter(t => t.id !== id)); 
          }; 

          const priorityStyles = { 
            high: 'bg-red-500', 
            medium: 'bg-orange-500', 
            low: 'bg-blue-500' 
          }; 

          const TABS = ['today', 'week', 'month', 'year']; 
          
          return ( 
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mt-6">
              <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">To-Do List</h3>
              
              {/* Period Tabs */}
              <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
                <nav className="-mb-px flex space-x-6">
                  {TABS.map(tab => (
                    <button 
                      key={tab} 
                      onClick={() => setActiveTab(tab)} 
                      className={`capitalize py-2 px-1 border-b-2 font-medium text-sm ${
                        activeTab === tab 
                          ? 'border-teal-500 text-teal-600 dark:text-teal-400' 
                          : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600'
                      }`}
                    >
                      {tab === 'week' || tab === 'month' || tab === 'year' ? `This ${tab}` : tab}
                    </button>
                  ))}
                </nav>
              </div>

              {/* Completion Toggle */}
              <div className="flex justify-between items-center mb-4">
                <span className="text-sm text-gray-600 dark:text-gray-400">
                  {filteredTodos.length} {showCompleted ? 'completed' : 'incomplete'} tasks for {activeTab}
                </span>
                <button 
                  onClick={() => setShowCompleted(!showCompleted)}
                  className={`px-3 py-1 text-sm rounded-full ${
                    showCompleted 
                      ? 'bg-teal-500 text-white' 
                      : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                  }`}
                >
                  {showCompleted ? 'Show Incomplete' : 'Show Completed'}
                </button>
              </div>

              {/* Add Todo Form */}
              <form onSubmit={addTodo} className="mb-4">
                <input 
                  type="text" 
                  value={newTodoText} 
                  onChange={e => setNewTodoText(e.target.value)} 
                  placeholder={`Add a task for ${activeTab === 'week' || activeTab === 'month' || activeTab === 'year' ? `this ${activeTab}` : activeTab}...`} 
                  className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 mb-2" 
                />
                <div className="flex items-center justify-between">
                  <div className="flex space-x-2">
                    {['low', 'medium', 'high'].map(p => (
                      <button 
                        key={p} 
                        type="button" 
                        onClick={() => setNewTodoPriority(p)} 
                        className={`px-3 py-1 text-sm rounded-full capitalize border-2 ${
                          newTodoPriority === p 
                            ? 'bg-teal-500 text-white border-teal-500' 
                            : 'text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-500'
                        }`}
                      >
                        {p}
                      </button>
                    ))}
                  </div>
                  <button type="submit" className="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">
                    Add to {activeTab}
                  </button>
                </div>
              </form>

              {/* Todo List */}
              <ul className="space-y-2">
                {filteredTodos.length > 0 ? (
                  filteredTodos.map(todo => (
                    <li key={todo.id} className="flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50">
                      <div className={`w-2 h-6 rounded-sm mr-3 ${priorityStyles[todo.priority]}`}></div>
                      <input 
                        type="checkbox" 
                        checked={todo.completed} 
                        onChange={() => toggleTodo(todo.id)} 
                        className="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-teal-600 focus:ring-teal-500 cursor-pointer bg-gray-100 dark:bg-gray-900"
                      />
                      <span className={`flex-grow mx-3 ${todo.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'}`}>
                        {todo.text}
                      </span>
                      <button onClick={() => deleteTodo(todo.id)} className="text-gray-400 hover:text-red-500 text-sm">
                        Delete
                      </button>
                    </li>
                  ))
                ) : (
                  <p className="text-center text-gray-400 dark:text-gray-500 py-4">
                    {showCompleted ? `No completed tasks for ${activeTab}.` : `No tasks for ${activeTab}. Add some above!`}
                  </p>
                )}
              </ul>
            </div>
          );
      };

      const ToBuyList = ({ toBuy, setToBuy }) => { 
        const [newItemText, setNewItemText] = useState(''); 
        const addItem = (e) => { 
          e.preventDefault(); 
          if (newItemText.trim() === '') return; 
          setToBuy(prev => [{ id: Date.now(), text: newItemText, purchased: false }, ...prev]); 
          setNewItemText(''); 
        }; 
        const toggleItem = (id) => { 
          setToBuy(prev => prev.map(item => item.id === id ? { ...item, purchased: !item.purchased } : item)); 
        }; 
        const deleteItem = (id) => { 
          setToBuy(prev => prev.filter(item => item.id !== id)); 
        }; 
        
        return ( 
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mt-6"> 
            <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">To Buy List</h3> 
            <form onSubmit={addItem} className="flex mb-4"> 
              <input type="text" value={newItemText} onChange={e => setNewItemText(e.target.value)} placeholder="Add an item..." className="flex-grow shadow-sm appearance-none border rounded-l-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500" /> 
              <button type="submit" className="bg-teal-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-teal-600">Add</button> 
            </form> 
            <ul className="space-y-2"> 
              {toBuy.length > 0 ? toBuy.map(item => ( 
                <li key={item.id} className="flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50"> 
                  <input type="checkbox" checked={item.purchased} onChange={() => toggleItem(item.id)} className="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-teal-600 focus:ring-teal-500 cursor-pointer bg-gray-100 dark:bg-gray-900"/> 
                  <span className={`flex-grow mx-3 ${item.purchased ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'}`}>{item.text}</span> 
                  <button onClick={() => deleteItem(item.id)} className="text-gray-400 hover:text-red-500 text-sm">Remove</button> 
                </li> 
              )) : <p className="text-center text-gray-400 dark:text-gray-500 py-4">Your shopping list is empty.</p>} 
            </ul> 
          </div> 
        ); 
      };
      
      const BMICalculator = () => { 
        const [height, setHeight] = useState(''); 
        const [weight, setWeight] = useState(''); 
        const [bmi, setBmi] = useState(null); 
        
        const calculateBmi = (e) => { 
          e.preventDefault(); 
          const h = parseFloat(height) / 100; 
          const w = parseFloat(weight); 
          if (h > 0 && w > 0) { 
            const bmiValue = w / (h * h); 
            setBmi(bmiValue.toFixed(2)); 
          } 
        }; 
        
        const getBmiCategory = (bmi) => { 
          if (bmi < 18.5) return { category: 'Underweight', color: 'text-blue-500' }; 
          if (bmi >= 18.5 && bmi <= 24.9) return { category: 'Normal weight', color: 'text-green-500' }; 
          if (bmi >= 25 && bmi <= 29.9) return { category: 'Overweight', color: 'text-orange-500' }; 
          return { category: 'Obesity', color: 'text-red-500' }; 
        }; 
        
        return ( 
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mt-6"> 
            <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">BMI Calculator</h3> 
            <form onSubmit={calculateBmi} className="grid grid-cols-2 gap-4 mb-4"> 
              <div> 
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Height (cm)</label> 
                <input type="number" value={height} onChange={e => setHeight(e.target.value)} required className="mt-1 shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" /> 
              </div> 
              <div> 
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Weight (kg)</label> 
                <input type="number" value={weight} onChange={e => setWeight(e.target.value)} required className="mt-1 shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" /> 
              </div> 
              <div className="col-span-2"> 
                <button type="submit" className="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Calculate</button> 
              </div> 
            </form> 
            {bmi && ( 
              <div className="text-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"> 
                <p className="text-gray-600 dark:text-gray-300">Your BMI is</p> 
                <p className="text-4xl font-bold text-teal-600 dark:text-teal-400 my-1">{bmi}</p> 
                <p className={`font-semibold ${getBmiCategory(bmi).color}`}>{getBmiCategory(bmi).category}</p> 
              </div> 
            )} 
          </div> 
        ); 
      };
      
      // ENHANCED REALISTIC BODY MAP (MuscleWiki Style)
      const BodyMap = ({ onSelect }) => {
          const [hovered, setHovered] = useState(null);
          const [view, setView] = useState('front');

          const muscleGroups = {
              front: {
                  'Chest': { 
                      path: "M100,80 C90,85 85,95 85,105 L85,125 C85,135 95,140 105,140 C115,140 125,135 125,125 L125,105 C125,95 120,85 110,80 Z",
                      color: "#FF6B6B"
                  },
                  'Shoulders': {
                      path: "M75,85 C70,90 68,100 75,110 L85,105 C80,100 80,95 85,90 Z M155,85 C160,90 162,100 155,110 L145,105 C150,100 150,95 145,90 Z",
                      color: "#4ECDC4"
                  },
                  'Biceps': {
                      path: "M90,120 C85,125 85,135 90,140 L100,135 C95,130 95,125 100,120 Z M150,120 C155,125 155,135 150,140 L140,135 C145,130 145,125 140,120 Z",
                      color: "#45B7D1"
                  },
                  'Forearms': {
                      path: "M90,145 C85,150 85,160 90,165 L100,160 C95,155 95,150 100,145 Z M150,145 C155,150 155,160 150,165 L140,160 C145,155 145,150 140,145 Z",
                      color: "#96CEB4"
                  },
                  'Abs': {
                      path: "M95,125 L100,140 L105,145 L110,147 L115,145 L120,140 L125,125 Z",
                      color: "#FFEAA7"
                  },
                  'Obliques': {
                      path: "M85,125 L90,140 L95,145 L100,147 L85,147 Z M145,125 L140,140 L135,145 L130,147 L145,147 Z",
                      color: "#DDA15E"
                  },
                  'Quads': {
                      path: "M95,150 L100,180 L105,200 L110,205 L115,200 L120,180 L125,150 Z",
                      color: "#BC6C25"
                  },
                  'Calves': {
                      path: "M100,205 L105,220 L110,225 L115,220 L120,205 Z",
                      color: "#606C38"
                  }
              },
              back: {
                  'Back': {
                      path: "M95,80 C85,85 80,95 80,105 L80,125 C80,135 90,140 100,140 C110,140 120,135 120,125 L120,105 C120,95 115,85 105,80 Z",
                      color: "#9D4EDD"
                  },
                  'Shoulders': {
                      path: "M75,85 C70,90 68,100 75,110 L85,105 C80,100 80,95 85,90 Z M155,85 C160,90 162,100 155,110 L145,105 C150,100 150,95 145,90 Z",
                      color: "#4ECDC4"
                  },
                  'Triceps': {
                      path: "M90,120 C85,125 85,135 90,140 L100,135 C95,130 95,125 100,120 Z M150,120 C155,125 155,135 150,140 L140,135 C145,130 145,125 140,120 Z",
                      color: "#118AB2"
                  },
                  'Forearms': {
                      path: "M90,145 C85,150 85,160 90,165 L100,160 C95,155 95,150 100,145 Z M150,145 C155,150 155,160 150,165 L140,160 C145,155 145,150 140,145 Z",
                      color: "#96CEB4"
                  },
                  'Glutes': {
                      path: "M95,150 L100,170 L105,180 L110,185 L115,180 L120,170 L125,150 Z",
                      color: "#EF476F"
                  },
                  'Hamstrings': {
                      path: "M95,180 L100,200 L105,210 L110,215 L115,210 L120,200 L125,180 Z",
                      color: "#06D6A0"
                  },
                  'Calves': {
                      path: "M100,215 L105,230 L110,235 L115,230 L120,215 Z",
                      color: "#606C38"
                  }
              }
          };

          const bodyOutline = {
              front: "M100,50 C80,50 65,65 65,85 L60,120 L55,160 L60,200 L70,240 L85,260 L100,270 L115,260 L130,240 L140,200 L145,160 L140,120 L135,85 C135,65 120,50 100,50 Z",
              back: "M100,50 C80,50 65,65 65,85 L60,120 L55,160 L60,200 L70,240 L85,260 L100,270 L115,260 L130,240 L140,200 L145,160 L140,120 L135,85 C135,65 120,50 100,50 Z"
          };

          return ( 
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 mt-6 text-center">
              <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-2">Workout Guide - Select Muscle Group</h3>
              <div className="flex justify-center my-2">
                <div className="bg-gray-200 dark:bg-gray-700 rounded-full p-1 flex">
                  <button onClick={() => setView('front')} className={`px-4 py-1 text-sm font-semibold rounded-full ${view === 'front' ? 'bg-teal-500 text-white' : 'text-gray-600 dark:text-gray-300'}`}>Front</button>
                  <button onClick={() => setView('back')} className={`px-4 py-1 text-sm font-semibold rounded-full ${view === 'back' ? 'bg-teal-500 text-white' : 'text-gray-600 dark:text-gray-300'}`}>Back</button>
                </div>
              </div>
              <svg viewBox="40 30 120 250" className="w-full h-auto max-h-96 cursor-pointer">
                {/* Body Outline */}
                <path d={bodyOutline[view]} fill="#F8F9FA" className="dark:fill-gray-600" stroke="#DEE2E6" strokeWidth="2" />
                
                {/* Muscle Groups */}
                {Object.entries(muscleGroups[view]).map(([name, data]) => (
                    <path 
                        key={name} 
                        d={data.path} 
                        fill={hovered === name ? data.color : "#ADB5BD"} 
                        className="cursor-pointer transition-all duration-200 hover:opacity-80"
                        stroke="#495057" 
                        strokeWidth="1" 
                        onClick={() => onSelect(name)}
                        onMouseEnter={() => setHovered(name)}
                        onMouseLeave={() => setHovered(null)}
                    />
                ))}
              </svg>
              <p className="text-gray-800 dark:text-gray-200 font-semibold text-lg mt-2 h-6">
                {hovered ? `${hovered} - Click for exercises` : 'Hover over muscles to see names'}
              </p>
            </div>
          );
      };

      const ExerciseItem = ({ exercise }) => {
          return (
            <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
              <div className="flex justify-between items-start mb-3">
                <h4 className="font-bold text-lg text-gray-800 dark:text-white">{exercise.name}</h4>
                <div className="flex space-x-2">
                  <span className={`px-2 py-1 text-xs rounded-full ${
                      exercise.difficulty === 'Beginner' ? 'bg-green-100 text-green-800' :
                      exercise.difficulty === 'Intermediate' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-red-100 text-red-800'
                  }`}>
                      {exercise.difficulty}
                  </span>
                  <span className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                      {exercise.equipment}
                  </span>
                </div>
              </div>
              <div className="flex flex-col md:flex-row gap-4">
                <div className="w-full md:w-1/2">
                  <img 
                      src={exercise.gif} 
                      alt={`Animation of ${exercise.name}`} 
                      className="w-full h-48 object-cover rounded-md bg-white border dark:border-gray-600"
                      onError={(e) => {
                          e.target.src = 'https://via.placeholder.com/300x200/4A5568/FFFFFF?text=Exercise+Demonstration';
                      }}
                  />
                </div>
                <div className="w-full md:w-1/2">
                  <p className="text-gray-700 dark:text-gray-300 mb-3">{exercise.description}</p>
                  <div className="bg-white dark:bg-gray-600 p-3 rounded-md">
                      <h5 className="font-semibold text-gray-800 dark:text-white mb-2">Instructions:</h5>
                      <p className="text-sm text-gray-600 dark:text-gray-300">{exercise.description}</p>
                  </div>
                </div>
              </div>
            </div>
          );
      };

      const ExerciseListView = ({ bodyPart, onBack }) => {
          const exercises = WORKOUT_DATA[bodyPart] || [];
          return (
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mt-6">
              <div className="flex items-center mb-4">
                <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 mr-2 dark:text-white">
                  <BackArrowIcon />
                </button>
                <h3 className="font-bold text-xl text-gray-800 dark:text-white">{bodyPart} Workouts</h3>
              </div>
              {exercises.length > 0 ? (
                <div className="space-y-4">
                  {exercises.map((ex) => (
                    <ExerciseItem key={ex.id} exercise={ex} />
                  ))}
                </div>
              ) : (
                <p className="dark:text-white text-center">No exercises found for this muscle group.</p>
              )}
            </div>
          );
      };

      const Stopwatch = () => {
          const [time, setTime] = useState(0);
          const [isRunning, setIsRunning] = useState(false);
          const [laps, setLaps] = useState([]);
          const intervalRef = useRef(null);
          const startTimeRef = useRef(0);

          useEffect(() => {
              if (isRunning) {
                  startTimeRef.current = Date.now() - time;
                  intervalRef.current = setInterval(() => { setTime(Date.now() - startTimeRef.current); }, 10);
              } else { clearInterval(intervalRef.current); }
              return () => clearInterval(intervalRef.current);
          }, [isRunning]);

          const formatTime = (time) => { 
            const minutes = Math.floor((time / 60000) % 60).toString().padStart(2, '0'); 
            const seconds = Math.floor((time / 1000) % 60).toString().padStart(2, '0'); 
            const milliseconds = Math.floor((time % 1000) / 10).toString().padStart(2, '0'); 
            return `${minutes}:${seconds}:${milliseconds}`; 
          };
          
          const handleLap = () => { setLaps(prev => [...prev, time]); };
          const handleReset = () => { setIsRunning(false); setTime(0); setLaps([]); };

          return (
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 mt-6 text-center">
                  <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-3">Stopwatch</h3>
                  <p className="text-6xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter my-4">{formatTime(time)}</p>
                  <div className="flex justify-center space-x-4">
                      <button onClick={() => setIsRunning(!isRunning)} className={`w-24 font-semibold py-2 px-4 rounded-lg transition-colors ${isRunning ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-teal-500 text-white hover:bg-teal-600'}`}>{isRunning ? 'Pause' : 'Start'}</button>
                      <button onClick={handleLap} disabled={!isRunning && time === 0} className="w-24 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50">Lap</button>
                      <button onClick={handleReset} className="w-24 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Reset</button>
                  </div>
                  {laps.length > 0 && <ul className="text-left mt-4 max-h-40 overflow-y-auto">{laps.map((lap, index) => <li key={index} className="text-sm text-gray-600 dark:text-gray-400 p-1">Lap {index + 1}: {formatTime(lap)}</li>)}</ul>}
              </div>
          );
      };
      
      const PomodoroTimerNew = () => {
        const MODES = { work: 25, short: 5, long: 15 };
        const [mode, setMode] = useState('work');
        const [totalTime, setTotalTime] = useState(MODES[mode] * 60);
        const [timeLeft, setTimeLeft] = useState(totalTime);
        const [isActive, setIsActive] = useState(false);
        const timerId = useRef(null);

        useEffect(() => {
          const newTotalTime = MODES[mode] * 60;
          setTotalTime(newTotalTime);
          setTimeLeft(newTotalTime);
          setIsActive(false);
          clearInterval(timerId.current);
        }, [mode]);

        useEffect(() => {
          if (isActive && timeLeft > 0) {
            timerId.current = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
          } else if (timeLeft === 0 && isActive) {
            clearInterval(timerId.current);
            setIsActive(false);
            if (Notification.permission === 'granted') {
                new Notification("Pomodoro Finished!", { 
                    body: `${mode === 'work' ? 'Break time!' : 'Back to work!'} ✨`,
                    icon: 'https://placehold.co/96x96/06890a/FFF?text=🔔'
                });
            }
          }
          return () => clearInterval(timerId.current);
        }, [isActive, timeLeft, mode]);

        const toggleTimer = () => setIsActive(!isActive);
        const resetTimer = () => { setTimeLeft(totalTime); setIsActive(false); };
        const formatTime = s => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        const radius = 80;
        const circumference = 2 * Math.PI * radius;
        const progress = (timeLeft / totalTime) * circumference;

        return (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 text-center">
            <div className="flex justify-center space-x-2 mb-4">
                {Object.keys(MODES).map(m => (
                    <button key={m} onClick={() => setMode(m)} className={`px-4 py-2 text-sm font-semibold rounded-full capitalize ${mode === m ? 'bg-teal-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>
                        {m === 'work' ? 'Work' : m === 'short' ? 'Short Break' : 'Long Break'}
                    </button>
                ))}
            </div>
            <div className="relative w-56 h-56 mx-auto flex items-center justify-center">
              <svg className="w-full h-full transform -rotate-90">
                <circle cx="112" cy="112" r={radius} strokeWidth="12" className="text-gray-200 dark:text-gray-700" stroke="currentColor" fill="transparent" />
                <circle cx="112" cy="112" r={radius} strokeWidth="12" className="text-teal-500 dark:text-teal-400" stroke="currentColor" fill="transparent"
                  strokeDasharray={circumference}
                  strokeDashoffset={circumference - progress}
                  style={{ transition: 'stroke-dashoffset 0.5s linear' }}
                />
              </svg>
              <div className="absolute">
                <p className="text-5xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter">{formatTime(timeLeft)}</p>
              </div>
            </div>
             <div className="flex justify-center space-x-4 mt-4">
                <button onClick={toggleTimer} className={`w-24 font-semibold py-2 px-4 rounded-lg transition-colors ${isActive ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-teal-500 text-white hover:bg-teal-600'}`}>
                    {isActive ? 'Pause' : 'Start'}
                </button>
                <button onClick={resetTimer} className="w-24 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                    Reset
                </button>
            </div>
          </div>
        );
      };

      // FIXED AUTH COMPONENT - Working Google Sign-in
      const AuthComponent = ({ onSignIn, onSkip }) => {
        const [isLoading, setIsLoading] = useState(false);

        const signInWithGoogle = async () => {
          setIsLoading(true);
          try {
            if (auth) {
              const provider = new firebase.auth.GoogleAuthProvider();
              const result = await auth.signInWithPopup(provider);
              console.log('Google sign-in successful:', result.user);
              onSignIn(result.user);
            } else {
              console.log('Firebase auth not available, using test mode');
              const testUser = {
                uid: 'test-user-' + Date.now(),
                displayName: 'Test User',
                email: 'test@example.com',
                photoURL: 'https://placehold.co/96x96/E0E7FF/4F46E5?text=T'
              };
              onSignIn(testUser);
            }
          } catch (error) {
            console.error('Error signing in:', error);
            alert('Firebase not configured. Using test mode.');
            const testUser = {
              uid: 'test-user-' + Date.now(),
              displayName: 'Test User',
              email: 'test@example.com',
              photoURL: 'https://placehold.co/96x96/E0E7FF/4F46E5?text=T'
            };
            onSignIn(testUser);
          } finally {
            setIsLoading(false);
          }
        };

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md m-4 text-center">
              <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Welcome to Mero Jivan</h2>
              <p className="text-gray-600 dark:text-gray-300 mb-6">Sign in to sync your data across devices</p>
              <button
                onClick={signInWithGoogle}
                disabled={isLoading}
                className="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 flex items-center justify-center space-x-3 hover:bg-gray-50 transition-colors disabled:opacity-50"
              >
                <GoogleIcon />
                <span className="text-gray-700 font-medium">
                  {isLoading ? 'Signing in...' : 'Sign in with Google'}
                </span>
              </button>
              <button
                onClick={onSkip}
                className="w-full mt-4 bg-teal-500 text-white rounded-lg py-3 px-4 hover:bg-teal-600 transition-colors"
              >
                Continue without signing in
              </button>
            </div>
          </div>
        );
      };

      // --- VIEWS / SECTIONS ---
      const MoneyView = ({ transactions, setTransactions, lendBorrow, setLendBorrow }) => { 
        const [view, setView] = useState('transactions');
        const [displayDate, setDisplayDate] = useState(() => { const today = gregorianToNepali(new Date().toISOString().split('T')[0]); return { year: today.year, month: today.month }; });
        const [isModalOpen, setIsModalOpen] = useState(false); 
        const [modalInitialType, setModalInitialType] = useState('expense'); 
        const [statsFilter, setStatsFilter] = useState('month');

        const filteredTransactions = useMemo(() => {
            const now = new Date();
            const currentNepali = gregorianToNepali(now.toISOString().split('T')[0]);
            let lastMonthNepaliYear = currentNepali.month === 1 ? currentNepali.year - 1 : currentNepali.year;
            let lastMonthNepaliMonth = currentNepali.month === 1 ? 12 : currentNepali.month - 1;

            if (statsFilter === 'month') {
                return transactions.filter(t => { const d = gregorianToNepali(t.date); return d.year === currentNepali.year && d.month === currentNepali.month });
            }
            if (statsFilter === 'lastMonth') {
                 return transactions.filter(t => { const d = gregorianToNepali(t.date); return d.year === lastMonthNepaliYear && d.month === lastMonthNepaliMonth });
            }
            return transactions;
        }, [transactions, statsFilter]);
        
        const monthlyTransactions = useMemo(() => transactions.filter(t => { const nepaliDate = gregorianToNepali(t.date); return nepaliDate.year === displayDate.year && nepaliDate.month === displayDate.month}), [transactions, displayDate]);
        const { totalIncome, totalExpense, balance } = useMemo(() => { let i = 0, e = 0; monthlyTransactions.forEach(t => t.type === 'income' ? i += t.amount : e += t.amount); return { totalIncome: i, totalExpense: e, balance: i - e }; }, [monthlyTransactions]); 
        const expenseByCategory = useMemo(() => { const map = {}; filteredTransactions.filter(t => t.type === 'expense').forEach(t => { if (!map[t.categoryId]) { const info = ALL_CATEGORIES[t.categoryId] || { name: 'Other', color: '#6C757D' }; map[t.categoryId] = { id: t.categoryId, name: info.name, value: 0, color: info.color }; } map[t.categoryId].value += t.amount; }); return Object.values(map).sort((a, b) => b.value - a.value); }, [filteredTransactions]); 
        
        const openModal = (type) => { setModalInitialType(type); setIsModalOpen(true); };
        const addTransaction = (transaction) => { 
          const newTransaction = { ...transaction, id: Date.now() };
          setTransactions(prev => [newTransaction, ...prev]); 
          setIsModalOpen(false); 
        };
        const changeMonth = (direction) => { setDisplayDate(p => { let m=p.month+direction, y=p.year; if(m>12){m=1;y++;} if(m<1){m=12;y--;} return NEPALI_MONTH_DATA[y]?{year:y,month:m}:p;}); };
        
        const exportToCsv = () => {
            let csvContent = "data:text/csv;charset=utf-8,Date,Nepali Date,Type,Category,Amount,Description\n";
            transactions.forEach(t => { const nepaliDate = gregorianToNepali(t.date); const categoryName = ALL_CATEGORIES[t.categoryId]?.name || 'N/A'; const description = t.description ? `"${t.description.replace(/"/g, '""')}"` : ''; csvContent += `${t.date},${nepaliDate.year}-${nepaliDate.month}-${nepaliDate.day},${t.type},${categoryName},${t.amount},${description}\n`; });
            const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "transactions.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        return (
          <React.Fragment>
            <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
              <nav className="-mb-px flex space-x-6">
                <button onClick={() => setView('transactions')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'transactions' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Transactions</button>
                <button onClick={() => setView('stats')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'stats' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Stats</button>
                <button onClick={() => setView('lendBorrow')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'lendBorrow' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Lend/Borrow</button>
              </nav>
            </div>

            {view === 'transactions' && (
              <>
                <div className="bg-gradient-to-br from-green-500 to-teal-600 text-white rounded-2xl shadow-lg p-6 mb-6">
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <p className="text-sm opacity-80">Total Balance</p>
                      <p className="text-4xl font-bold tracking-tight">रु {balance.toLocaleString('en-NP')}</p>
                    </div>
                    <div className="text-right">
                      <div className="flex items-center justify-end space-x-2">
                        <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-white/20 text-white">&lt;</button>
                        <h2 className="text-md font-semibold text-white">{NEPALI_MONTHS[displayDate.month-1]} {displayDate.year}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-white/20 text-white">&gt;</button>
                      </div>
                    </div>
                  </div>
                  <div className="flex justify-between mt-6 text-sm">
                    <div>
                      <p className="opacity-80">Income</p>
                      <p className="font-semibold">रु {totalIncome.toLocaleString('en-NP')}</p>
                    </div>
                    <div className="text-right">
                      <p className="opacity-80">Expense</p>
                      <p className="font-semibold">रु {totalExpense.toLocaleString('en-NP')}</p>
                    </div>
                  </div>
                </div>

                <div className="flex space-x-4 mb-6">
                  <button onClick={() => openModal('income')} className="flex-1 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm hover:shadow-md transition-shadow flex items-center justify-center space-x-2">
                    <div className="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><PlusIcon /></div>
                    <p className="font-semibold text-gray-700 dark:text-gray-200">Income</p>
                  </button>
                  <button onClick={() => openModal('expense')} className="flex-1 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm hover:shadow-md transition-shadow flex items-center justify-center space-x-2">
                    <div className="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><MinusIcon /></div>
                    <p className="font-semibold text-gray-700 dark:text-gray-200">Expense</p>
                  </button>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 mb-6">
                  <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-3 px-2">Recent Transactions</h3>
                  <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                    {monthlyTransactions.length === 0 ? (
                      <p className="text-center text-gray-500 dark:text-gray-400 py-4">No transactions this month.</p>
                    ) : (
                      monthlyTransactions.map(t => {
                        const category = ALL_CATEGORIES[t.categoryId] || {};
                        const nepaliDate = gregorianToNepali(t.date);
                        return (
                          <div key={t.id} className="p-2 rounded-lg flex items-center hover:bg-gray-50 dark:hover:bg-gray-700/50">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${t.type === 'income' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                              {category.Icon && <category.Icon className={`${t.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}/>}
                            </div>
                            <div className="flex-grow">
                              <p className="font-semibold text-gray-800 dark:text-white">{t.description || category.name}</p>
                              <p className="text-sm text-gray-500 dark:text-gray-400">{nepaliDate.day} {nepaliDate.monthName}</p>
                            </div>
                            <p className={`font-bold text-right ${t.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                              {t.type === 'income' ? '+' : '-'} रु {t.amount.toLocaleString('en-NP')}
                            </p>
                          </div>
                        )
                      })
                    )}
                  </div>
                </div>

                <div className="mt-6 text-center">
                  <button onClick={exportToCsv} className="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition-all flex items-center mx-auto space-x-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Export Excel</span>
                  </button>
                </div>
              </>
            )}

            {view === 'stats' && (
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h2 className="text-xl font-bold text-gray-700 dark:text-white mb-4 text-center">Expense Breakdown</h2>
                <div className="flex justify-center my-2">
                  <div className="bg-gray-200 dark:bg-gray-700 rounded-full p-1 flex">
                    <button onClick={() => setStatsFilter('month')} className={`px-3 py-1 text-sm rounded-full ${statsFilter==='month' ? 'bg-white dark:bg-gray-600' : ''}`}>This Month</button>
                    <button onClick={() => setStatsFilter('lastMonth')} className={`px-3 py-1 text-sm rounded-full ${statsFilter==='lastMonth' ? 'bg-white dark:bg-gray-600' : ''}`}>Last Month</button>
                    <button onClick={() => setStatsFilter('all')} className={`px-3 py-1 text-sm rounded-full ${statsFilter==='all' ? 'bg-white dark:bg-gray-600' : ''}`}>All Time</button>
                  </div>
                </div>
                {expenseByCategory.length > 0 ? (
                  <>
                    <PieChart data={expenseByCategory} />
                    <ul className="mt-4 space-y-2">
                      {expenseByCategory.map(cat=>(
                        <li key={cat.id} className="flex items-center justify-between text-sm p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                          <div className="flex items-center">
                            <span className="w-3 h-3 rounded-full mr-3" style={{backgroundColor: cat.color}}></span>
                            <span className="font-medium text-gray-700 dark:text-gray-300">{cat.name}</span>
                          </div>
                          <span className="font-semibold text-gray-800 dark:text-gray-200">रु {cat.value.toLocaleString('en-NP')}</span>
                        </li>
                      ))}
                    </ul>
                  </>
                ) : (
                  <p className="text-center text-gray-500 dark:text-gray-400 py-10">No expenses recorded for this period.</p>
                )}
              </div>
            )}

            {view === 'lendBorrow' && <LendBorrowView lendBorrow={lendBorrow} setLendBorrow={setLendBorrow} />}
            <AddTransactionModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} addTransaction={addTransaction} initialType={modalInitialType} />
          </React.Fragment>
        );
      };

      const LifeView = ({ todos, setTodos, toBuy, setToBuy }) => ( 
        <React.Fragment>
          <PomodoroTimerNew />
          <ToDoList todos={todos} setTodos={setTodos} />
          <ToBuyList toBuy={toBuy} setToBuy={setToBuy} />
        </React.Fragment> 
      );

      const GrowView = () => { 
          const [selectedBodyPart, setSelectedBodyPart] = useState(null);
          
          if (selectedBodyPart) { 
              return (<ExerciseListView bodyPart={selectedBodyPart} onBack={() => setSelectedBodyPart(null)} />);
          }

          return (
            <React.Fragment>
              <BodyMap onSelect={setSelectedBodyPart} />
              <Stopwatch />
              <BMICalculator />
            </React.Fragment>
          ); 
      };

      const AccountView = ({ settings, setSettings, clearAllData, isConfirming, setIsConfirming, user, onSignIn, onSignOut }) => {
          const { name, profilePicUrl, theme } = settings;
          const fileInputRef = useRef(null);
          const [showAuth, setShowAuth] = useState(false);

          const handleImageClick = () => fileInputRef.current.click();
          
          const handleFileChange = (e) => {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                      setSettings(prev => ({ ...prev, profilePicUrl: reader.result }));
                  };
                  reader.readAsDataURL(file);
              }
          };
          
          const handleInputChange = (e) => {
              const { name, value } = e.target;
              setSettings(prev => ({ ...prev, [name]: value }));
          };

          const handleThemeChange = (e) => {
              const newTheme = e.target.checked ? 'dark' : 'light';
              setSettings(prev => ({ ...prev, theme: newTheme }));
          };
          
          return (
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 space-y-6">
                   <h2 className="text-xl font-bold text-gray-800 dark:text-white text-center">Settings</h2>
                   
                   {/* User Info */}
                   <div className="flex flex-col items-center space-y-4">
                      <div className="relative">
                        <img 
                          src={user?.photoURL || profilePicUrl || `https://placehold.co/96x96/E0E7FF/4F46E5?text=${name.charAt(0)}`} 
                          alt="Profile" 
                          className="w-24 h-24 rounded-full shadow-md object-cover"
                        />
                        <button onClick={handleImageClick} className="absolute -bottom-1 -right-1 bg-teal-500 text-white p-2 rounded-full hover:bg-teal-600">
                          <EditIcon />
                        </button>
                        <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 text-center">Name</label>
                          <input type="text" name="name" value={name} onChange={handleInputChange} placeholder="Your Name" className="mt-1 text-center text-lg font-semibold shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"/>
                      </div>
                      {user && user.uid !== 'local' ? (
                        <div className="text-center">
                          <p className="text-sm text-gray-600 dark:text-gray-400">Signed in as: {user.email}</p>
                          <button onClick={onSignOut} className="mt-2 text-sm text-red-500 hover:text-red-600">Sign Out</button>
                        </div>
                      ) : (
                        <div className="text-center">
                          <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">Not signed in</p>
                          <button onClick={() => setShowAuth(true)} className="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600">
                            Sign in to sync data
                          </button>
                        </div>
                      )}
                   </div>

                   {/* Cloud Sync Status */}
                   {user.uid !== 'local' && (
                     <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                       <h4 className="font-semibold text-blue-800 dark:text-blue-300 mb-2">Cloud Sync Status</h4>
                       <p className="text-sm text-blue-700 dark:text-blue-400">
                         ✓ Signed in as: {user.email}<br/>
                         ✓ User ID: {user.uid}<br/>
                         ✓ Firebase: {database ? 'Connected' : 'Not Available'}<br/>
                         ✓ Data will sync automatically
                       </p>
                     </div>
                   )}

                   {/* Appearance Settings */}
                   <div>
                       <h3 className="font-semibold text-gray-700 dark:text-gray-300 mb-2">Appearance</h3>
                       <div className="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                           <span className="text-gray-800 dark:text-gray-200">Dark Mode</span>
                           <label className="relative inline-flex items-center cursor-pointer">
                              <input type="checkbox" checked={theme === 'dark'} onChange={handleThemeChange} className="sr-only peer" />
                              <div className="w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                           </label>
                       </div>
                   </div>

                   {/* Data Management */}
                   <div>
                       <h3 className="font-semibold text-gray-700 dark:text-gray-300 mb-2">Data Management</h3>
                       <button onClick={() => setIsConfirming(true)} className="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Clear All App Data</button>
                       {isConfirming && (
                           <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                               <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-sm text-center">
                                   <h4 className="font-bold text-lg text-gray-900 dark:text-white">Are you sure?</h4>
                                   <p className="text-sm text-gray-600 dark:text-gray-300 my-2">This will permanently delete all your app data. This action cannot be undone.</p>
                                   <div className="flex justify-center space-x-4 mt-4">
                                       <button onClick={() => setIsConfirming(false)} className="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                                       <button onClick={clearAllData} className="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Yes, Clear Data</button>
                                   </div>
                               </div>
                           </div>
                       )}
                   </div>

                   {/* Auth Modal */}
                   {showAuth && (
                     <AuthComponent 
                       onSignIn={(user) => { onSignIn(user); setShowAuth(false); }} 
                       onSkip={() => setShowAuth(false)}
                     />
                   )}
              </div>
          );
      };

      const LendBorrowView = ({ lendBorrow, setLendBorrow }) => {
          const [type, setType] = useState('lend');
          const [person, setPerson] = useState('');
          const [amount, setAmount] = useState('');
          const [description, setDescription] = useState('');
          const [selectedPerson, setSelectedPerson] = useState('all');

          const people = useMemo(() => [...new Set(lendBorrow.map(item => item.person))], [lendBorrow]);
          
          const filteredData = useMemo(() => {
              if (selectedPerson === 'all') return lendBorrow;
              return lendBorrow.filter(item => item.person === selectedPerson);
          }, [lendBorrow, selectedPerson]);

          const { totalLent, totalBorrowed } = useMemo(() => {
              let lent = 0, borrowed = 0;
              lendBorrow.forEach(item => {
                  if(item.type === 'lend') lent += item.amount;
                  else borrowed += item.amount;
              });
              return { totalLent: lent, totalBorrowed: borrowed };
          }, [lendBorrow]);

          const handleSubmit = (e) => {
              e.preventDefault();
              if (!person || !amount) return;
              setLendBorrow(prev => [{
                  id: Date.now(),
                  type,
                  person,
                  amount: parseFloat(amount),
                  description,
                  date: new Date().toISOString()
              }, ...prev]);
              setPerson('');
              setAmount('');
              setDescription('');
          };
          
          return (
            <div className="space-y-6">
                <div className="grid grid-cols-2 gap-4 text-center">
                    <div className="bg-red-100 dark:bg-red-900/50 p-4 rounded-lg">
                        <p className="text-sm text-red-800 dark:text-red-300">You Borrowed</p>
                        <p className="text-2xl font-bold text-red-600 dark:text-red-400">रु {totalBorrowed.toLocaleString('en-NP')}</p>
                    </div>
                    <div className="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg">
                        <p className="text-sm text-green-800 dark:text-green-300">You Lent</p>
                        <p className="text-2xl font-bold text-green-600 dark:text-green-400">रु {totalLent.toLocaleString('en-NP')}</p>
                    </div>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
                     <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">Add New Record</h3>
                     <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="flex gap-2">
                           <button type="button" onClick={() => setType('lend')} className={`flex-1 py-2 rounded-lg font-semibold ${type === 'lend' ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>Lent</button>
                           <button type="button" onClick={() => setType('borrow')} className={`flex-1 py-2 rounded-lg font-semibold ${type === 'borrow' ? 'bg-red-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>Borrowed</button>
                        </div>
                        <input type="text" list="people" value={person} onChange={e => setPerson(e.target.value)} placeholder="Person's Name" required className="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        <datalist id="people">
                            {people.map(p => <option key={p} value={p} />)}
                        </datalist>
                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="Amount (रु)" required className="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="Description (optional)" className="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        <button type="submit" className="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Add Record</button>
                     </form>
                </div>
                
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg text-gray-800 dark:text-white">History</h3>
                        <select value={selectedPerson} onChange={e => setSelectedPerson(e.target.value)} className="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="all">All People</option>
                            {people.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                    </div>
                    <div className="space-y-2">
                        {filteredData.length === 0 ? <p className="text-center text-gray-500 py-4">No records yet.</p> : 
                        [...filteredData].sort((a,b) => b.id - a.id).map(item => (
                            <div key={item.id} className={`p-3 rounded-lg flex justify-between items-center ${item.type === 'lend' ? 'bg-green-50 dark:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/30'}`}>
                                <div>
                                    <p className="font-semibold dark:text-white">{item.person}</p>
                                    <p className="text-sm text-gray-600 dark:text-gray-400">{item.description || 'No description'}</p>
                                </div>
                                <p className={`font-bold ${item.type === 'lend' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                    {item.type === 'lend' ? '+' : '-'} रु {item.amount.toLocaleString('en-NP')}
                                </p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
          );
      };

      // --- MAIN APP COMPONENT ---
      const App = () => {
          const [currentView, setCurrentView] = useState('money'); 
          const [user, setUser] = useState({ uid: 'local', displayName: 'User', email: 'local@user.com' });
          const [showAuth, setShowAuth] = useState(false);
          const [syncStatus, setSyncStatus] = useState('idle');
          
          const useStickyState = (defaultValue, key) => {
              const [value, setValue] = useState(() => {
                  try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                  } catch (e) {
                    return defaultValue;
                  }
              });
              useEffect(() => {
                  try {
                    window.localStorage.setItem(key, JSON.stringify(value));
                  } catch (error) {
                    console.error("Could not save to localStorage", error);
                  }
              }, [key, value]);
              return [value, setValue];
          };

          const [settings, setSettings] = useStickyState({ name: 'User', profilePicUrl: '', theme: 'light' }, 'lifeDashboard-settings');
          const [transactions, setTransactions] = useStickyState([], 'lifeDashboard-transactions');
          const [todos, setTodos] = useStickyState([], 'lifeDashboard-todos');
          const [toBuy, setToBuy] = useStickyState([], 'lifeDashboard-toBuy');
          const [lendBorrow, setLendBorrow] = useStickyState([], 'lifeDashboard-lendBorrow');
          const [isConfirmingClear, setIsConfirmingClear] = useState(false);
          
          // Improved Auth state listener
          useEffect(() => {
            if (auth) {
              const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                console.log('Auth state changed:', firebaseUser);
                
                if (firebaseUser) {
                  setUser(firebaseUser);
                  console.log('User signed in, loading cloud data...');
                  setSyncStatus('loading');
                  
                  // Load data from cloud
                  const cloudData = await loadDataFromCloud(firebaseUser.uid);
                  if (cloudData) {
                    console.log('Applying cloud data to local state');
                    setSyncStatus('synced');
                    // Only update if cloud data exists
                    if (cloudData.transactions) setTransactions(cloudData.transactions);
                    if (cloudData.todos) setTodos(cloudData.todos);
                    if (cloudData.toBuy) setToBuy(cloudData.toBuy);
                    if (cloudData.lendBorrow) setLendBorrow(cloudData.lendBorrow);
                    if (cloudData.settings) {
                      setSettings(prev => ({ ...prev, ...cloudData.settings }));
                    }
                  } else {
                    console.log('No cloud data found, using local data');
                    setSyncStatus('no-data');
                  }
                } else {
                  // User signed out
                  setUser({ uid: 'local', displayName: 'User', email: 'local@user.com' });
                  console.log('User signed out, using local storage');
                  setSyncStatus('local');
                }
              });
              return () => unsubscribe();
            }
          }, []);

          // Sync data to cloud when user is signed in and data changes
          useEffect(() => {
            const syncData = async () => {
              if (user && user.uid !== 'local') {
                console.log('Data changed, syncing to cloud...');
                setSyncStatus('syncing');
                const data = {
                  transactions,
                  todos,
                  toBuy,
                  lendBorrow,
                  settings,
                  lastSync: new Date().toISOString()
                };
                
                const success = await syncDataToCloud(user.uid, data);
                if (success) {
                  console.log('Cloud sync completed successfully');
                  setSyncStatus('synced');
                } else {
                  console.log('Cloud sync failed');
                  setSyncStatus('error');
                }
              }
            };

            // Use a timeout to debounce rapid changes
            const timeoutId = setTimeout(syncData, 1000);
            return () => clearTimeout(timeoutId);
          }, [transactions, todos, toBuy, lendBorrow, settings, user]);

          useEffect(() => {
              if (settings.theme === 'dark') {
                  document.documentElement.classList.add('dark');
              } else {
                  document.documentElement.classList.remove('dark');
              }
          }, [settings.theme]);

          const handleSignIn = (userData) => {
            setUser(userData);
            setShowAuth(false);
          };

          const handleSignOut = async () => {
            try {
              if (auth) {
                await auth.signOut();
              }
              setUser({ uid: 'local', displayName: 'User', email: 'local@user.com' });
              setSyncStatus('local');
            } catch (error) {
              console.error('Error signing out:', error);
            }
          };

          const clearAllData = () => {
              window.localStorage.clear();
              window.location.reload();
          };

          return (
              <div className="bg-gray-50 dark:bg-gray-900 min-h-screen font-sans flex flex-col">
                  <main className="flex-grow container mx-auto p-4 pb-24">
                      <header className="mb-6 flex items-center space-x-4">
                           <img src={user.photoURL || settings.profilePicUrl || `https://placehold.co/48x48/E0E7FF/4F46E5?text=${settings.name.charAt(0)}`} alt="Profile" className="w-12 h-12 rounded-full shadow-md object-cover"/>
                          <div>
                            <h1 className="text-2xl font-bold text-gray-800 dark:text-white">Hello, {settings.name}</h1>
                            <p className="text-gray-500 dark:text-gray-400 text-sm"><strong>Mero Jivan</strong> by Bidur Bhattarai</p>
                            {user.uid !== 'local' && (
                              <p className="text-xs text-teal-500">
                                {syncStatus === 'syncing' && '🔄 Syncing...'}
                                {syncStatus === 'synced' && '✓ Cloud Sync Active'}
                                {syncStatus === 'loading' && '📥 Loading from cloud...'}
                                {syncStatus === 'error' && '❌ Sync Error'}
                                {syncStatus === 'no-data' && 'ℹ️ No cloud data found'}
                              </p>
                            )}
                          </div>
                      </header>

                      {currentView === 'money' && (
                        <MoneyView 
                          transactions={transactions} 
                          setTransactions={setTransactions} 
                          lendBorrow={lendBorrow} 
                          setLendBorrow={setLendBorrow}
                        />
                      )}
                      {currentView === 'life' && (
                        <LifeView 
                          todos={todos} 
                          setTodos={setTodos} 
                          toBuy={toBuy} 
                          setToBuy={setToBuy}
                        />
                      )}
                      {currentView === 'grow' && <GrowView />}
                      {currentView === 'account' && (
                        <AccountView 
                          settings={settings} 
                          setSettings={setSettings} 
                          clearAllData={clearAllData} 
                          isConfirming={isConfirmingClear} 
                          setIsConfirming={setIsConfirmingClear}
                          user={user}
                          onSignIn={handleSignIn}
                          onSignOut={handleSignOut}
                        />
                      )}
                  </main>
                  
                  <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.2)]">
                       <div className="container mx-auto flex justify-around items-center p-2">
                          <button onClick={() => setCurrentView('money')} className={`p-3 rounded-full flex flex-col items-center w-20 ${currentView==='money' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><MoneyIcon /><span className="text-xs mt-1">Money</span></button>
                          <button onClick={() => setCurrentView('life')} className={`p-3 rounded-full flex flex-col items-center w-20 ${currentView==='life' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><LifeIcon /><span className="text-xs mt-1">Life</span></button>
                          <button onClick={() => setCurrentView('grow')} className={`p-3 rounded-full flex flex-col items-center w-20 ${currentView==='grow' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><GrowIcon /><span className="text-xs mt-1">Grow</span></button>
                          <button onClick={() => setCurrentView('account')} className={`p-3 rounded-full flex flex-col items-center w-20 ${currentView==='account' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><AccountIcon /><span className="text-xs mt-1">Account</span></button>
                      </div>
                  </div>

                  {/* Optional Auth Modal */}
                  {showAuth && (
                    <AuthComponent 
                      onSignIn={handleSignIn}
                      onSkip={() => setShowAuth(false)}
                    />
                  )}
              </div>
          );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
