<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mero Jivan</title>
    <!-- PWA MANIFEST -->
    <!-- Inline PWA manifest (replace old manifest link with this) -->
    <link rel="manifest" href='data:application/json;base64,eyJuYW1lIjoiTWVybyBKaXZhbiIsInNob3J0X25hbWUiOiJNZXJvIEppdmFuIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjMDY4OTBhIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly93YWxscGFwZXJzLWNsYW4uY29tL3dwLWNvbnRlbnQvdXBsb2Fkcy8yMDIyLzExL3JpY2stYW5kLW1vcnR5LW1hdGNoaW5nLXBmcC0yLmpwZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imh0dHBzOi8vd2FsbHBhcGVycy1jbGFuLmNvbS93cC1jb250ZW50L3VwbG9hZHMvMjAyMi8xMS9yaWNrLWFuZC1tb3J0eS1tYXRjaGluZy1wZnAtMi5qcGciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==' />
    <meta name="theme-color" content="#06890a">
    <!-- WEBSITE ICON (FAVICON) -->
    <link rel="icon" type="image/x-icon" href="https://ibb.co/fGqvxFFV">
    <!-- NOTIFICATION PERMISSION -->
    <script>if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        /* Disable zoom on mobile */
        html, body {
            touch-action: pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Allow scrolling */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
        }
        /* Streak circle animation */
        .streak-circle {
            transition: all 0.3s ease;
        }
        .streak-circle:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="scroll-container">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyCwQVdSe_BvFgxwXd4oP6PPOuh6NrJaXNY",
        authDomain: "mero-jivan-cd3a6.firebaseapp.com",
        databaseURL: "https://mero-jivan-cd3a6-default-rtdb.firebaseio.com",
        projectId: "mero-jivan-cd3a6",
        storageBucket: "mero-jivan-cd3a6.firebasestorage.app",
        messagingSenderId: "244728705595",
        appId: "1:244728705595:web:dddc0a53d7cae21bbba21e",
        measurementId: "G-3RVXWQMYTL"
      };

      // Initialize Firebase
      let auth, database;
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        auth = firebase.auth();
        database = firebase.database();
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.error('Firebase initialization failed:', error);
      }

      // --- ICONS (as SVG components) ---
      const MoneyIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>);
      const LifeIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>);
      const GrowIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>);
      const AccountIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>);
      const PlusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>);
      const MinusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" /></svg>);
      const FoodIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>);
      const TransportIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>);
      const BillsIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>);
      const ShoppingIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>);
      const FunIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
      const HealthIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>);
      const OtherIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg>);
      const SalaryIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>);
      const GiftIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>);
      const BackArrowIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>);
      const EditIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>);
      const DeleteIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>);
      const GoogleIcon = () => (<svg className="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>);
      const MovieIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" /></svg>);
      const BookIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>);
      const ShareIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>);
      const CheckIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>);
      const FireIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clipRule="evenodd"/></svg>);

      // --- DATA & HELPERS ---
      const CATEGORIES = { expense: [{ id: 'food', name: 'Food', Icon: FoodIcon, color: '#FF6384' },{ id: 'transport', name: 'Transport', Icon: TransportIcon, color: '#36A2EB' },{ id: 'home', name: 'Home', Icon: OtherIcon, color: '#FFCE56' },{ id: 'bills', name: 'Bills', Icon: BillsIcon, color: '#4BC0C0' },{ id: 'shopping', name: 'Shopping', Icon: ShoppingIcon, color: '#9966FF' },{ id: 'fun', name: 'Fun', Icon: FunIcon, color: '#FF9F40' },{ id: 'health', name: 'Health', Icon: HealthIcon, color: '#E83E8C' },{ id: 'other_expense', name: 'Other', Icon: OtherIcon, color: '#6C757D' }], income: [{ id: 'salary', name: 'Salary', Icon: SalaryIcon },{ id: 'gift', name: 'Gift', Icon: GiftIcon },{ id: 'other_income', name: 'Other', Icon: OtherIcon }] };
      const ALL_CATEGORIES = [...CATEGORIES.expense, ...CATEGORIES.income].reduce((acc, cat) => { acc[cat.id] = cat; return acc; }, {});
      const NEPALI_MONTH_DATA = { 2070: [30, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2071: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2072: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2073: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2074: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2075: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2076: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2077: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2078: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2079: [31, 31, 32, 32, 31, 30, 29, 30, 29, 30, 29, 31], 2080: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2081: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2082: [30, 32, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2083: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2084: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2085: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2086: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2087: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30], 2088: [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30], 2089: [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31], 2090: [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30] };
      const NEPALI_MONTHS = ['Baishakh','Jestha','Ashadh','Shrawan','Bhadra','Ashwin','Kartik','Mangsir','Poush','Magh','Falgun','Chaitra'];
      const NEPALI_YEAR_START_GREGORIAN_DATE = { 2070: '2013-04-14', 2071: '2014-04-14', 2072: '2015-04-14', 2073: '2016-04-13', 2074: '2017-04-14', 2075: '2018-04-14', 2076: '2019-04-14', 2077: '2020-04-13', 2080: '2023-04-14', 2081: '2024-04-13', 2082: '2025-04-14', 2083: '2026-04-14', 2084: '2027-04-14', 2085: '2028-04-13', 2086: '2029-04-14', 2087: '2030-04-14', 2088: '2031-04-14', 2089: '2032-04-13', 2090: '2033-04-14' };
      const gregorianToNepali = (gregorianDate) => { const defaultDate = { year: 2081, month: 1, day: 1, monthName: 'Baishakh' }; if (!gregorianDate) return defaultDate; const inputDate = new Date(gregorianDate); inputDate.setUTCHours(0, 0, 0, 0); let nepaliYear; const sortedYears = Object.keys(NEPALI_YEAR_START_GREGORIAN_DATE).sort((a, b) => b - a); for (const year of sortedYears) { const startDate = new Date(NEPALI_YEAR_START_GREGORIAN_DATE[year]); startDate.setUTCHours(0, 0, 0, 0); if (inputDate >= startDate) { nepaliYear = parseInt(year); break; } } if (!nepaliYear) return defaultDate; const nepaliYearStartDate = new Date(NEPALI_YEAR_START_GREGORIAN_DATE[nepaliYear]); nepaliYearStartDate.setUTCHours(0, 0, 0, 0); const dayDiff = Math.round((inputDate - nepaliYearStartDate) / (1000 * 60 * 60 * 24)); let nepaliMonth = 1, nepaliDay = dayDiff + 1; const monthDaysData = NEPALI_MONTH_DATA[nepaliYear]; if (!monthDaysData) return defaultDate; for (let i = 0; i < monthDaysData.length; i++) { const daysInMonth = monthDaysData[i]; if (nepaliDay <= daysInMonth) break; else { nepaliDay -= daysInMonth; nepaliMonth++; } } return { year: nepaliYear, month: nepaliMonth, day: nepaliDay, monthName: NEPALI_MONTHS[nepaliMonth - 1] }; };
      const nepaliToGregorian = (nepaliYear, nepaliMonth, nepaliDay) => { const gregorianStartDateStr = NEPALI_YEAR_START_GREGORIAN_DATE[nepaliYear]; if (!gregorianStartDateStr) return new Date().toISOString().split('T')[0]; const gregorianStartDate = new Date(gregorianStartDateStr); let daysToAdd = 0; const monthData = NEPALI_MONTH_DATA[nepaliYear]; if (!monthData) return new Date().toISOString().split('T')[0]; for (let i = 0; i < nepaliMonth - 1; i++) { daysToAdd += monthData[i]; } daysToAdd += nepaliDay - 1; const resultDate = new Date(gregorianStartDate.getTime()); resultDate.setDate(gregorianStartDate.getDate() + daysToAdd); return resultDate.toISOString().split('T')[0]; };
      
      // =============================================
      // FIXED SYNC SYSTEM WITH PROPER CONFLICT RESOLUTION
      // =============================================

      // Track user activity to prevent sync during input
      let userIsActive = false;
      let activityTimer = null;

      const trackUserActivity = () => {
          userIsActive = true;
          if (activityTimer) clearTimeout(activityTimer);
          activityTimer = setTimeout(() => {
              userIsActive = false;
          }, 3000); // 3 seconds after last activity
      };

      // Listen for user activity
      if (typeof document !== 'undefined') {
          document.addEventListener('click', trackUserActivity);
          document.addEventListener('keydown', trackUserActivity);
          document.addEventListener('input', trackUserActivity);
      }

      // FIXED: Enhanced conflict resolution that properly handles deletions
      const resolveDataConflicts = (localData, cloudData, dataType) => {
          if (!cloudData || cloudData.length === 0) return localData;
          if (!localData || localData.length === 0) return cloudData;

          const localMap = new Map(localData.map(item => [item.id, item]));
          const cloudMap = new Map(cloudData.map(item => [item.id, item]));
          const mergedData = [];
          const allIds = new Set([...localMap.keys(), ...cloudMap.keys()]);

          for (const id of allIds) {
              const localItem = localMap.get(id);
              const cloudItem = cloudMap.get(id);

              if (!localItem) {
                  // Item only exists in cloud - keep it
                  mergedData.push(cloudItem);
              } else if (!cloudItem) {
                  // Item only exists locally - keep it
                  mergedData.push(localItem);
              } else {
                  // Item exists in both - resolve conflict using timestamp
                  const localTimestamp = localItem.lastModified || (localItem.id && typeof localItem.id === 'number' ? localItem.id : 0);
                  const cloudTimestamp = cloudItem.lastModified || (cloudItem.id && typeof cloudItem.id === 'number' ? cloudItem.id : 0);

                  // Use the newer version (higher timestamp)
                  if (cloudTimestamp > localTimestamp) {
                      mergedData.push(cloudItem);
                  } else {
                      mergedData.push(localItem);
                  }
              }
          }

          return mergedData.sort((a, b) => (b.id || 0) - (a.id || 0));
      };

      // Debounced sync with user activity check
      let syncTimeout = null;
      const DEBOUNCE_DELAY = 5000; // 5 seconds delay

      const syncDataToCloud = async (userId, data, forceSync = false) => {
          try {
              // Don't sync if user is active or no database
              if (userIsActive && !forceSync) {
                  console.log('‚è∏Ô∏è Sync paused - user is active');
                  return false;
              }

              if (!database || !userId || userId === 'local') {
                  console.log('‚è≠Ô∏è Cloud sync skipped - no database or local user');
                  return false;
              }

              console.log('üîÑ Starting sync to cloud for user:', userId);
              
              // Get current cloud data for conflict resolution
              const snapshot = await database.ref(`users/${userId}`).once('value');
              const existingCloudData = snapshot.val();
              
              // FIXED: Resolve conflicts for each data type with proper deletion handling
              const syncedData = {
                  transactions: resolveDataConflicts(data.transactions || [], existingCloudData?.transactions || [], 'transactions'),
                  todos: resolveDataConflicts(data.todos || [], existingCloudData?.todos || [], 'todos'),
                  toBuy: resolveDataConflicts(data.toBuy || [], existingCloudData?.toBuy || [], 'toBuy'),
                  lendBorrow: resolveDataConflicts(data.lendBorrow || [], existingCloudData?.lendBorrow || [], 'lendBorrow'),
                  movies: resolveDataConflicts(data.movies || [], existingCloudData?.movies || [], 'movies'),
                  books: resolveDataConflicts(data.books || [], existingCloudData?.books || [], 'books'),
                  habits: resolveDataConflicts(data.habits || [], existingCloudData?.habits || [], 'habits'),
                  archive: resolveDataConflicts(data.archive || [], existingCloudData?.archive || [], 'archive'),
                  settings: { ...existingCloudData?.settings, ...data.settings },
                  lastSync: new Date().toISOString(),
                  lastSyncBy: 'device_' + Math.random().toString(36).substr(2, 9)
              };

              await database.ref(`users/${userId}`).set(syncedData);
              console.log('‚úÖ Data successfully synced to cloud with conflict resolution');
              return true;
          } catch (error) {
              console.error('‚ùå Error syncing to cloud:', error);
              return false;
          }
      };

      const loadDataFromCloud = async (userId) => {
          try {
              if (database && userId && userId !== 'local') {
                  console.log('üì• Loading data from cloud for user:', userId);
                  const snapshot = await database.ref(`users/${userId}`).once('value');
                  const cloudData = snapshot.val();
                  
                  if (cloudData) {
                      console.log('‚úÖ Cloud data loaded successfully');
                      return {
                          transactions: cloudData.transactions || [],
                          todos: cloudData.todos || [],
                          toBuy: cloudData.toBuy || [],
                          lendBorrow: cloudData.lendBorrow || [],
                          movies: cloudData.movies || [],
                          books: cloudData.books || [],
                          habits: cloudData.habits || [],
                          archive: cloudData.archive || [],
                          settings: cloudData.settings || {}
                      };
                  } else {
                      console.log('‚ÑπÔ∏è No cloud data found for user');
                      return null;
                  }
              }
          } catch (error) {
              console.error('‚ùå Error loading from cloud:', error);
          }
          return null;
      };

      // Enhanced real-time sync with proper debouncing
      const setupRealtimeListener = (userId, onDataChange) => {
          if (database && userId && userId !== 'local') {
              console.log('üëÇ Setting up real-time listener for user:', userId);
              const userRef = database.ref(`users/${userId}`);
              
              let isProcessing = false;
              
              // Real-time changes with debouncing
              userRef.on('value', (snapshot) => {
                  if (isProcessing || userIsActive) {
                      console.log('‚è∏Ô∏è Skipping real-time update - user active or processing');
                      return;
                  }
                  
                  isProcessing = true;
                  const cloudData = snapshot.val();
                  if (cloudData) {
                      console.log('üîÑ Real-time update received from cloud');
                      onDataChange(cloudData);
                  }
                  
                  setTimeout(() => {
                      isProcessing = false;
                  }, 2000); // 2 second cooldown
              }, (error) => {
                  console.error('‚ùå Real-time listener error:', error);
              });

              // Less frequent periodic sync (30 seconds)
              const periodicSync = setInterval(() => {
                  if (userIsActive) {
                      console.log('‚è∏Ô∏è Periodic sync skipped - user active');
                      return;
                  }
                  
                  console.log('‚è∞ Periodic sync check');
                  userRef.once('value').then((snapshot) => {
                      const cloudData = snapshot.val();
                      if (cloudData) {
                          onDataChange(cloudData);
                      }
                  });
              }, 30000); // 30 seconds

              return () => {
                  userRef.off('value');
                  clearInterval(periodicSync);
              };
          }
          return () => {};
      };

      // --- CHILD COMPONENTS ---
      const PieChart = ({ data }) => {
          const size = 192; const donutThickness = 24; const center = size / 2; const radius = center - (donutThickness / 2); if (!data || data.length === 0) return null; const total = data.reduce((sum, item) => sum + item.value, 0); if (total === 0) return null; let cumulativePercent = 0;
          const segments = data.map((item, index) => { const percent = item.value / total; const getCoordinatesForPercent = (p) => [center + radius * Math.cos(2 * Math.PI * p), center + radius * Math.sin(2 * Math.PI * p)]; const [startX, startY] = getCoordinatesForPercent(cumulativePercent); cumulativePercent += percent; const [endX, endY] = getCoordinatesForPercent(cumulativePercent); const largeArcFlag = percent > 0.5 ? 1 : 0; const pathData = `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`; return <path key={index} d={pathData} fill="none" stroke={item.color} strokeWidth={donutThickness} />; });
          return (<div className="relative w-48 h-48 mx-auto flex items-center justify-center"><svg viewBox={`0 0 ${size} ${size}`} className="transform -rotate-90">{segments}</svg><div className="absolute text-center"><p className="text-xs text-gray-500 dark:text-gray-400">Total Spent</p><p className="font-bold text-xl text-gray-800 dark:text-gray-200">‡§∞‡•Å {total.toLocaleString('en-NP')}</p></div></div>);
      };
      
      const NepaliDatePicker = ({ gregorianDate, setGregorianDate, onClose }) => { 
        const [currentNepaliDate, setCurrentNepaliDate] = useState(() => gregorianToNepali(gregorianDate)); 
        const changeMonth = (delta) => { 
          let newMonth = currentNepaliDate.month + delta; 
          let newYear = currentNepaliDate.year; 
          if (newMonth > 12) { newMonth = 1; newYear++; } 
          else if (newMonth < 1) { newMonth = 12; newYear--; } 
          if (NEPALI_MONTH_DATA[newYear]) { 
            setCurrentNepaliDate({ year: newYear, month: newMonth, day: 1 }); 
          } 
        }; 
        const daysInMonth = NEPALI_MONTH_DATA[currentNepaliDate.year]?.[currentNepaliDate.month - 1] || 30; 
        const firstDayOfMonthGregorian = nepaliToGregorian(currentNepaliDate.year, currentNepaliDate.month, 1); 
        const firstDayOfWeek = new Date(firstDayOfMonthGregorian).getDay(); 
        const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1); 
        const blanks = Array(firstDayOfWeek).fill(null); 
        return ( 
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50" onClick={onClose}> 
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 w-80" onClick={e => e.stopPropagation()}> 
              <div className="flex justify-between items-center mb-4"> 
                <button onClick={() => changeMonth(-1)} className="font-bold text-lg p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white">&lt;</button> 
                <div> 
                  <span className="font-bold text-lg dark:text-white">{NEPALI_MONTHS[currentNepaliDate.month - 1]}</span> 
                  <span className="text-lg ml-2 dark:text-gray-300">{currentNepaliDate.year}</span> 
                </div> 
                <button onClick={() => changeMonth(1)} className="font-bold text-lg p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white">&gt;</button> 
              </div> 
              <div className="grid grid-cols-7 gap-1 text-center text-sm"> 
                <div className="font-semibold text-gray-500 dark:text-gray-400">Sun</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Mon</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Tue</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Wed</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Thu</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Fri</div>
                <div className="font-semibold text-gray-500 dark:text-gray-400">Sat</div> 
                {blanks.map((_, i) => <div key={`blank-${i}`}></div>)} 
                {daysArray.map(day => { 
                  const isSelected = gregorianToNepali(gregorianDate).day === day && gregorianToNepali(gregorianDate).month === currentNepaliDate.month && gregorianToNepali(gregorianDate).year === currentNepaliDate.year; 
                  return ( 
                    <div key={day} onClick={() => { setGregorianDate(nepaliToGregorian(currentNepaliDate.year, currentNepaliDate.month, day)); onClose(); }} className={`p-2 rounded-full cursor-pointer dark:text-white ${isSelected ? 'bg-teal-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`}> 
                      {day} 
                    </div> 
                  ); 
                })} 
              </div> 
            </div> 
          </div> 
        ); 
      };
      
      // UPDATED: Add Transaction Modal with edit support
      const AddTransactionModal = ({ isOpen, onClose, addTransaction, initialType, editTransaction, transactionToEdit }) => { 
        const isEditing = !!transactionToEdit;
        const [type, setType] = useState(initialType); 
        const [amount, setAmount] = useState(''); 
        const [description, setDescription] = useState(''); 
        const [categoryId, setCategoryId] = useState(''); 
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]); 
        const [isDatePickerOpen, setIsDatePickerOpen] = useState(false); 
        
        useEffect(() => { 
          if (isEditing && transactionToEdit) {
            setType(transactionToEdit.type);
            setAmount(transactionToEdit.amount.toString());
            setDescription(transactionToEdit.description || '');
            setCategoryId(transactionToEdit.categoryId);
            setDate(transactionToEdit.date);
          } else {
            setType(initialType); 
            setAmount(''); 
            setDescription(''); 
            setCategoryId(CATEGORIES[initialType][0].id); 
            setDate(new Date().toISOString().split('T')[0]);
          }
        }, [isOpen, initialType, isEditing, transactionToEdit]); 
        
        if (!isOpen) return null; 
        
        const handleSubmit = (e) => { 
          e.preventDefault(); 
          if (!amount || !categoryId) return; 
          
          const transactionData = { 
            type, 
            amount: parseFloat(amount), 
            description, 
            categoryId, 
            date,
            lastModified: Date.now()
          };
          
          if (isEditing) {
            editTransaction({ ...transactionData, id: transactionToEdit.id });
          } else {
            addTransaction({ ...transactionData, id: Date.now() });
          }
        }; 
        
        const nepaliDate = gregorianToNepali(date); 
        
        return ( 
          <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40"> 
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md m-4"> 
              <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">
                {isEditing ? 'Edit Transaction' : (type === 'income' ? 'Add Income' : 'Add Expense')}
              </h2> 
              <form onSubmit={handleSubmit}> 
                <div className="mb-4"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Amount</label> 
                  <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:shadow-outline" placeholder="‡§∞‡•Å 0.00" required /> 
                </div> 
                <div className="mb-4"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Type</label>
                  <div className="flex gap-2 mb-3">
                    <button type="button" onClick={() => setType('income')} className={`flex-1 py-2 rounded-lg font-semibold ${type === 'income' ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>Income</button>
                    <button type="button" onClick={() => setType('expense')} className={`flex-1 py-2 rounded-lg font-semibold ${type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>Expense</button>
                  </div>
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Category</label> 
                  <div className="grid grid-cols-4 gap-2"> 
                    {CATEGORIES[type].map(cat => ( 
                      <button type="button" key={cat.id} onClick={() => setCategoryId(cat.id)} className={`p-2 rounded-lg border-2 ${categoryId === cat.id ? 'border-teal-500 bg-teal-50 dark:bg-teal-900/50' : 'border-gray-200 dark:border-gray-600'} flex flex-col items-center text-gray-700 dark:text-gray-300`}> 
                        <cat.Icon /> 
                        <span className="text-xs mt-1">{cat.name}</span> 
                      </button> 
                    ))} 
                  </div> 
                </div> 
                <div className="mb-4"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Description</label> 
                  <input type="text" value={description} onChange={e => setDescription(e.target.value)} className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" placeholder="e.g., Lunch with friends" /> 
                </div> 
                <div className="mb-6"> 
                  <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Date</label> 
                  <button type="button" onClick={() => setIsDatePickerOpen(true)} className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-left">{nepaliDate.day} {nepaliDate.monthName}, {nepaliDate.year}</button> 
                </div> 
                <div className="flex items-center justify-between"> 
                  <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg">Cancel</button> 
                  <button type="submit" className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">
                    {isEditing ? 'Update' : 'Save'}
                  </button> 
                </div> 
              </form> 
              {isDatePickerOpen && <NepaliDatePicker gregorianDate={date} setGregorianDate={setDate} onClose={() => setIsDatePickerOpen(false)} />} 
            </div> 
          </div> 
        ); 
      };
      
      // FIXED TODO LIST - SIMPLIFIED "ADD" BUTTON
      const ToDoList = ({ todos, setTodos, addToArchive }) => { 
          const [newTodoText, setNewTodoText] = useState(''); 
          const [newTodoPriority, setNewTodoPriority] = useState('medium'); 
          const [activeTab, setActiveTab] = useState('today'); 
          const [showCompleted, setShowCompleted] = useState(false);
          
          // Filter todos based on active tab and completion status
          const filteredTodos = useMemo(() => {
            // Only show todos that were created for this specific period
            let filtered = todos.filter(todo => todo.period === activeTab);

            // Separate completed and incomplete
            const incomplete = filtered.filter(todo => !todo.completed);
            const completed = filtered.filter(todo => todo.completed);

            return showCompleted ? completed : incomplete;
          }, [todos, activeTab, showCompleted]);

          const addTodo = (e) => { 
            e.preventDefault(); 
            if (newTodoText.trim() === '') return; 
            const newTodo = { 
              id: Date.now(), 
              text: newTodoText, 
              priority: newTodoPriority, 
              completed: false, 
              createdAt: new Date().toISOString(),
              period: activeTab, // Store which period this task belongs to
              lastModified: Date.now()
            };
            setTodos(prev => [newTodo, ...prev]); 
            setNewTodoText(''); 
            setNewTodoPriority('medium'); 
          }; 

          const toggleTodo = (id) => { 
            setTodos(prev => prev.map(t => t.id === id ? { ...t, completed: !t.completed, lastModified: Date.now() } : t)); 
          }; 

          // FIXED: Delete todo - COMPLETELY REMOVE from todos
          const deleteTodo = (id) => { 
            const todo = todos.find(t => t.id === id);
            if (todo) {
              addToArchive('todo', todo, setTodos);
            }
          }; 

          const priorityStyles = { 
            high: 'bg-red-500', 
            medium: 'bg-orange-500', 
            low: 'bg-blue-500' 
          }; 

          const TABS = ['today', 'week', 'month', 'year']; 
          
          return ( 
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
              <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">To-Do List</h3>
              
              {/* Period Tabs */}
              <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
                <nav className="-mb-px flex space-x-6">
                  {TABS.map(tab => (
                    <button 
                      key={tab} 
                      onClick={() => setActiveTab(tab)} 
                      className={`capitalize py-2 px-1 border-b-2 font-medium text-sm ${
                        activeTab === tab 
                          ? 'border-teal-500 text-teal-600 dark:text-teal-400' 
                          : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600'
                      }`}
                    >
                      {tab === 'week' || tab === 'month' || tab === 'year' ? `This ${tab}` : tab}
                    </button>
                  ))}
                </nav>
              </div>

              {/* Completion Toggle */}
              <div className="flex justify-between items-center mb-4">
                <span className="text-sm text-gray-600 dark:text-gray-400">
                  {filteredTodos.length} {showCompleted ? 'completed' : 'incomplete'} tasks for {activeTab}
                </span>
                <button 
                  onClick={() => setShowCompleted(!showCompleted)}
                  className={`px-3 py-1 text-sm rounded-full ${
                    showCompleted 
                      ? 'bg-teal-500 text-white' 
                      : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                  }`}
                >
                  {showCompleted ? 'Show Incomplete' : 'Show Completed'}
                </button>
              </div>

              {/* Add Todo Form */}
              <form onSubmit={addTodo} className="mb-4">
                <input 
                  type="text" 
                  value={newTodoText} 
                  onChange={e => setNewTodoText(e.target.value)} 
                  placeholder={`Add a task for ${activeTab === 'week' || activeTab === 'month' || activeTab === 'year' ? `this ${activeTab}` : activeTab}...`} 
                  className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500 mb-2" 
                />
                <div className="flex items-center justify-between">
                  <div className="flex space-x-2">
                    {['low', 'medium', 'high'].map(p => (
                      <button 
                        key={p} 
                        type="button" 
                        onClick={() => setNewTodoPriority(p)} 
                        className={`px-3 py-1 text-sm rounded-full capitalize border-2 ${
                          newTodoPriority === p 
                            ? 'bg-teal-500 text-white border-teal-500' 
                            : 'text-gray-600 dark:text-gray-300 border-gray-300 dark:border-gray-500'
                        }`}
                      >
                        {p}
                      </button>
                    ))}
                  </div>
                  <button type="submit" className="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">
                    Add
                  </button>
                </div>
              </form>

              {/* Todo List */}
              <ul className="space-y-2">
                {filteredTodos.length > 0 ? (
                  filteredTodos.map(todo => (
                    <li key={todo.id} className="flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50">
                      <div className={`w-2 h-6 rounded-sm mr-3 ${priorityStyles[todo.priority]}`}></div>
                      <input 
                        type="checkbox" 
                        checked={todo.completed} 
                        onChange={() => toggleTodo(todo.id)} 
                        className="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-teal-600 focus:ring-teal-500 cursor-pointer bg-gray-100 dark:bg-gray-900"
                      />
                      <span className={`flex-grow mx-3 ${todo.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'}`}>
                        {todo.text}
                      </span>
                      <button onClick={() => deleteTodo(todo.id)} className="text-gray-400 hover:text-red-500 text-sm">
                        Delete
                      </button>
                    </li>
                  ))
                ) : (
                  <p className="text-center text-gray-400 dark:text-gray-500 py-4">
                    {showCompleted ? `No completed tasks for ${activeTab}.` : `No tasks for ${activeTab}. Add some above!`}
                  </p>
                )}
              </ul>
            </div>
          );
      };

      const ToBuyList = ({ toBuy, setToBuy, addToArchive }) => { 
        const [newItemText, setNewItemText] = useState(''); 
        const addItem = (e) => { 
          e.preventDefault(); 
          if (newItemText.trim() === '') return; 
          setToBuy(prev => [{ id: Date.now(), text: newItemText, purchased: false, lastModified: Date.now() }, ...prev]); 
          setNewItemText(''); 
        }; 
        const toggleItem = (id) => { 
          setToBuy(prev => prev.map(item => item.id === id ? { ...item, purchased: !item.purchased, lastModified: Date.now() } : item)); 
        }; 
        
        // FIXED: Delete item - COMPLETELY REMOVE from toBuy
        const deleteItem = (id) => { 
          const item = toBuy.find(i => i.id === id);
          if (item) {
            addToArchive('toBuy', item, setToBuy);
          }
        }; 
        
        return ( 
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6"> 
            <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">To Buy List</h3> 
            <form onSubmit={addItem} className="flex mb-4"> 
              <input type="text" value={newItemText} onChange={e => setNewItemText(e.target.value)} placeholder="Add an item..." className="flex-grow shadow-sm appearance-none border rounded-l-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500" /> 
              <button type="submit" className="bg-teal-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-teal-600">Add</button> 
            </form> 
            <ul className="space-y-2"> 
              {toBuy.length > 0 ? toBuy.map(item => ( 
                <li key={item.id} className="flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50"> 
                  <input type="checkbox" checked={item.purchased} onChange={() => toggleItem(item.id)} className="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-teal-600 focus:ring-teal-500 cursor-pointer bg-gray-100 dark:bg-gray-900"/> 
                  <span className={`flex-grow mx-3 ${item.purchased ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-300'}`}>{item.text}</span> 
                  <button onClick={() => deleteItem(item.id)} className="text-gray-400 hover:text-red-500 text-sm">Remove</button> 
                </li> 
              )) : <p className="text-center text-gray-400 dark:text-gray-500 py-4">Your shopping list is empty.</p>} 
            </ul> 
          </div> 
        ); 
      };
      
      const BMICalculator = () => { 
        const [height, setHeight] = useState(''); 
        const [weight, setWeight] = useState(''); 
        const [bmi, setBmi] = useState(null); 
        
        const calculateBmi = (e) => { 
          e.preventDefault(); 
          const h = parseFloat(height) / 100; 
          const w = parseFloat(weight); 
          if (h > 0 && w > 0) { 
            const bmiValue = w / (h * h); 
            setBmi(bmiValue.toFixed(2)); 
          } 
        }; 
        
        const getBmiCategory = (bmi) => { 
          if (bmi < 18.5) return { category: 'Underweight', color: 'text-blue-500' }; 
          if (bmi >= 18.5 && bmi <= 24.9) return { category: 'Normal weight', color: 'text-green-500' }; 
          if (bmi >= 25 && bmi <= 29.9) return { category: 'Overweight', color: 'text-orange-500' }; 
          return { category: 'Obesity', color: 'text-red-500' }; 
        }; 
        
        return ( 
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6"> 
            <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">BMI Calculator</h3> 
            <form onSubmit={calculateBmi} className="grid grid-cols-2 gap-4 mb-4"> 
              <div> 
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Height (cm)</label> 
                <input type="number" value={height} onChange={e => setHeight(e.target.value)} required className="mt-1 shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" /> 
              </div> 
              <div> 
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Weight (kg)</label> 
                <input type="number" value={weight} onChange={e => setWeight(e.target.value)} required className="mt-1 shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600" /> 
              </div> 
              <div className="col-span-2"> 
                <button type="submit" className="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Calculate</button> 
              </div> 
            </form> 
            {bmi && ( 
              <div className="text-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"> 
                <p className="text-gray-600 dark:text-gray-300">Your BMI is</p> 
                <p className="text-4xl font-bold text-teal-600 dark:text-teal-400 my-1">{bmi}</p> 
                <p className={`font-semibold ${getBmiCategory(bmi).color}`}>{getBmiCategory(bmi).category}</p> 
              </div> 
            )} 
          </div> 
        ); 
      };

      // UPDATED HABIT TRACKER COMPONENT
      const HabitTracker = ({ habits, setHabits, addToArchive }) => {
        const [newHabitName, setNewHabitName] = useState('');
        const [selectedPeriod, setSelectedPeriod] = useState('daily');
        const [selectedHabit, setSelectedHabit] = useState(null);
        
        // Add new habit
        const addHabit = (e) => {
          e.preventDefault();
          if (!newHabitName.trim()) return;
          
          const newHabit = {
            id: Date.now(),
            name: newHabitName,
            period: selectedPeriod,
            createdAt: new Date().toISOString(),
            history: {},
            streak: 0,
            lastModified: Date.now()
          };
          
          setHabits(prev => [newHabit, ...prev]);
          setNewHabitName('');
        };
        
        // FIXED: Delete habit - COMPLETELY REMOVE from habits
        const deleteHabit = (id) => {
          const habit = habits.find(h => h.id === id);
          if (habit) {
            addToArchive('habit', habit, setHabits);
          }
        };
        
        // Track habit completion
        const trackHabit = (habitId, date, status) => {
          setHabits(prev => prev.map(habit => {
            if (habit.id === habitId) {
              const newHistory = { ...habit.history, [date]: status };
              
              // Calculate streak
              const streak = calculateStreak(newHistory);
              
              return {
                ...habit,
                history: newHistory,
                streak: streak,
                lastModified: Date.now()
              };
            }
            return habit;
          }));
        };

        // Calculate streak from history
        const calculateStreak = (history) => {
          const dates = Object.keys(history).sort();
          let currentStreak = 0;
          let checkingDate = new Date();
          
          // Check backwards for consecutive completed habits
          for (let i = 0; i < 365; i++) {
            const dateStr = checkingDate.toISOString().split('T')[0];
            if (history[dateStr] === 'done') {
              currentStreak++;
            } else if (history[dateStr] === 'not-done') {
              break;
            } else {
              // No entry - streak continues for skipped days, breaks for neutral
              if (dates.includes(dateStr)) break;
            }
            
            checkingDate.setDate(checkingDate.getDate() - 1);
          }
          
          return currentStreak;
        };
        
        // Get status for today
        const getTodayStatus = (habit) => {
          const today = new Date().toISOString().split('T')[0];
          return habit.history[today] || 'neutral';
        };
        
        // Render status button
        const StatusButton = ({ habit, date, currentStatus, onStatusChange }) => {
          const statusConfig = {
            'done': { label: '‚úì', class: 'bg-green-500 text-white', next: 'not-done' },
            'not-done': { label: '‚úó', class: 'bg-red-500 text-white', next: 'neutral' },
            'neutral': { label: '‚Äî', class: 'bg-gray-300 text-gray-700', next: 'done' }
          };
          
          const config = statusConfig[currentStatus];
          
          return (
            <button
              onClick={() => onStatusChange(habit.id, date, config.next)}
              className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all hover:scale-110 ${config.class}`}
              title={`Mark as ${config.next === 'done' ? 'Done' : config.next === 'not-done' ? 'Not Done' : 'Neutral'}`}
            >
              {config.label}
            </button>
          );
        };

        // Streak circle component
        const StreakCircle = ({ habit }) => {
          const maxStreak = 30; // Maximum streak for circle calculation
          const percentage = Math.min((habit.streak / maxStreak) * 100, 100);
          const radius = 16;
          const circumference = 2 * Math.PI * radius;
          const strokeDasharray = circumference;
          const strokeDashoffset = circumference - (percentage / 100) * circumference;

          return (
            <div className="relative">
              <svg className="w-10 h-10 transform -rotate-90" onClick={() => setSelectedHabit(habit)}>
                <circle
                  cx="20"
                  cy="20"
                  r={radius}
                  stroke="currentColor"
                  strokeWidth="3"
                  fill="transparent"
                  className="text-gray-200 dark:text-gray-700"
                />
                <circle
                  cx="20"
                  cy="20"
                  r={radius}
                  stroke="currentColor"
                  strokeWidth="3"
                  fill="transparent"
                  strokeDasharray={strokeDasharray}
                  strokeDashoffset={strokeDashoffset}
                  className="text-orange-500 transition-all duration-300 ease-in-out"
                  style={{ strokeLinecap: 'round' }}
                />
              </svg>
              <div className="absolute inset-0 flex items-center justify-center" onClick={() => setSelectedHabit(habit)}>
                <span className="text-xs font-bold text-gray-700 dark:text-gray-300">{habit.streak}</span>
              </div>
            </div>
          );
        };

        // Habit history modal
        const HabitHistoryModal = ({ habit, onClose }) => {
          if (!habit) return null;

          const today = new Date();
          const last30Days = Array.from({ length: 30 }, (_, i) => {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            return date.toISOString().split('T')[0];
          }).reverse();

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50" onClick={onClose}>
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md m-4" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-xl font-bold text-gray-800 dark:text-white">{habit.name} - History</h3>
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                
                <div className="mb-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Current Streak:</span>
                    <div className="flex items-center space-x-1">
                      <FireIcon className="text-orange-500" />
                      <span className="font-bold text-orange-500">{habit.streak} days</span>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-7 gap-2">
                  {last30Days.map(date => {
                    const status = habit.history[date] || 'neutral';
                    const dayDate = new Date(date);
                    const isToday = date === new Date().toISOString().split('T')[0];
                    
                    return (
                      <div key={date} className="flex flex-col items-center">
                        <span className={`text-xs mb-1 ${isToday ? 'text-teal-500 font-bold' : 'text-gray-400'}`}>
                          {dayDate.getDate()}
                        </span>
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${
                          status === 'done' ? 'bg-green-500 text-white' :
                          status === 'not-done' ? 'bg-red-500 text-white' :
                          'bg-gray-300 text-gray-700'
                        }`}>
                          {status === 'done' ? '‚úì' : status === 'not-done' ? '‚úó' : '‚Äî'}
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="mt-4 flex justify-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                  <div className="flex items-center space-x-1">
                    <div className="w-3 h-3 bg-green-500 rounded"></div>
                    <span>Done</span>
                  </div>
                  <div className="flex items-center space-x-1">
                    <div className="w-3 h-3 bg-red-500 rounded"></div>
                    <span>Not Done</span>
                  </div>
                  <div className="flex items-center space-x-1">
                    <div className="w-3 h-3 bg-gray-300 rounded"></div>
                    <span>Neutral</span>
                  </div>
                </div>
              </div>
            </div>
          );
        };
        
        const today = new Date().toISOString().split('T')[0];
        
        return (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
            <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">Habit Tracker</h3>
            
            {/* Add Habit Form */}
            <form onSubmit={addHabit} className="mb-6">
              <div className="flex gap-2 mb-3">
                <input
                  type="text"
                  value={newHabitName}
                  onChange={(e) => setNewHabitName(e.target.value)}
                  placeholder="Enter new habit..."
                  className="flex-1 shadow-sm appearance-none border rounded-lg py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                />
                <select
                  value={selectedPeriod}
                  onChange={(e) => setSelectedPeriod(e.target.value)}
                  className="shadow-sm border rounded-lg py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                >
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <button type="submit" className="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">
                Add Habit
              </button>
            </form>
            
            {/* Habits List */}
            <div className="space-y-3">
              {habits.length === 0 ? (
                <p className="text-center text-gray-500 dark:text-gray-400 py-4">No habits yet. Add your first habit above!</p>
              ) : (
                habits.map(habit => (
                  <div key={habit.id} className="border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                    <div className="flex items-center justify-between">
                      {/* Habit Name and Status */}
                      <div className="flex items-center space-x-3 flex-1">
                        <StatusButton
                          habit={habit}
                          date={today}
                          currentStatus={getTodayStatus(habit)}
                          onStatusChange={trackHabit}
                        />
                        <span className="font-semibold text-gray-800 dark:text-white">{habit.name}</span>
                      </div>
                      
                      {/* Streak Circle and Info */}
                      <div className="flex items-center space-x-2">
                        <StreakCircle habit={habit} />
                        <div className="flex items-center space-x-1">
                          <FireIcon className="text-orange-500 w-4 h-4" />
                          <span className="text-sm font-bold text-orange-500">{habit.streak}</span>
                        </div>
                        <button
                          onClick={() => deleteHabit(habit.id)}
                          className="text-gray-400 hover:text-red-500 p-1 ml-2"
                          title="Delete habit"
                        >
                          <DeleteIcon />
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>

            {/* Habit History Modal */}
            {selectedHabit && (
              <HabitHistoryModal 
                habit={selectedHabit} 
                onClose={() => setSelectedHabit(null)} 
              />
            )}
          </div>
        );
      };

      const Stopwatch = () => {
          const [time, setTime] = useState(0);
          const [isRunning, setIsRunning] = useState(false);
          const [laps, setLaps] = useState([]);
          const intervalRef = useRef(null);
          const startTimeRef = useRef(0);

          useEffect(() => {
              if (isRunning) {
                  startTimeRef.current = Date.now() - time;
                  intervalRef.current = setInterval(() => { setTime(Date.now() - startTimeRef.current); }, 10);
              } else { clearInterval(intervalRef.current); }
              return () => clearInterval(intervalRef.current);
          }, [isRunning]);

          const formatTime = (time) => { 
            const minutes = Math.floor((time / 60000) % 60).toString().padStart(2, '0'); 
            const seconds = Math.floor((time / 1000) % 60).toString().padStart(2, '0'); 
            const milliseconds = Math.floor((time % 1000) / 10).toString().padStart(2, '0'); 
            return `${minutes}:${seconds}:${milliseconds}`; 
          };
          
          const handleLap = () => { setLaps(prev => [...prev, time]); };
          const handleReset = () => { setIsRunning(false); setTime(0); setLaps([]); };

          return (
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 text-center">
                  <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-3">Stopwatch</h3>
                  <p className="text-6xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter my-4">{formatTime(time)}</p>
                  <div className="flex justify-center space-x-4">
                      <button onClick={() => setIsRunning(!isRunning)} className={`w-24 font-semibold py-2 px-4 rounded-lg transition-colors ${isRunning ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-teal-500 text-white hover:bg-teal-600'}`}>{isRunning ? 'Pause' : 'Start'}</button>
                      <button onClick={handleLap} disabled={!isRunning && time === 0} className="w-24 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50">Lap</button>
                      <button onClick={handleReset} className="w-24 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Reset</button>
                  </div>
                  {laps.length > 0 && <ul className="text-left mt-4 max-h-40 overflow-y-auto">{laps.map((lap, index) => <li key={index} className="text-sm text-gray-600 dark:text-gray-400 p-1">Lap {index + 1}: {formatTime(lap)}</li>)}</ul>}
              </div>
          );
      };
      
      const PomodoroTimerNew = () => {
        const MODES = { work: 25, short: 5, long: 15 };
        const [mode, setMode] = useState('work');
        const [totalTime, setTotalTime] = useState(MODES[mode] * 60);
        const [timeLeft, setTimeLeft] = useState(totalTime);
        const [isActive, setIsActive] = useState(false);
        const timerId = useRef(null);

        useEffect(() => {
          const newTotalTime = MODES[mode] * 60;
          setTotalTime(newTotalTime);
          setTimeLeft(newTotalTime);
          setIsActive(false);
          clearInterval(timerId.current);
        }, [mode]);

        useEffect(() => {
          if (isActive && timeLeft > 0) {
            timerId.current = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
          } else if (timeLeft === 0 && isActive) {
            clearInterval(timerId.current);
            setIsActive(false);
            if (Notification.permission === 'granted') {
                new Notification("Pomodoro Finished!", { 
                    body: `${mode === 'work' ? 'Break time!' : 'Back to work!'} ‚ú®`,
                    icon: 'https://placehold.co/96x96/06890a/FFF?text=üîî'
                });
            }
          }
          return () => clearInterval(timerId.current);
        }, [isActive, timeLeft, mode]);

        const toggleTimer = () => setIsActive(!isActive);
        const resetTimer = () => { setTimeLeft(totalTime); setIsActive(false); };
        const formatTime = s => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        const radius = 80;
        const circumference = 2 * Math.PI * radius;
        const progress = (timeLeft / totalTime) * circumference;

        return (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 text-center">
            <div className="flex justify-center space-x-2 mb-4">
                {Object.keys(MODES).map(m => (
                    <button key={m} onClick={() => setMode(m)} className={`px-4 py-2 text-sm font-semibold rounded-full capitalize ${mode === m ? 'bg-teal-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>
                        {m === 'work' ? 'Work' : m === 'short' ? 'Short Break' : 'Long Break'}
                    </button>
                ))}
            </div>
            <div className="relative w-56 h-56 mx-auto flex items-center justify-center">
              <svg className="w-full h-full transform -rotate-90">
                <circle cx="112" cy="112" r={radius} strokeWidth="12" className="text-gray-200 dark:text-gray-700" stroke="currentColor" fill="transparent" />
                <circle cx="112" cy="112" r={radius} strokeWidth="12" className="text-teal-500 dark:text-teal-400" stroke="currentColor" fill="transparent"
                  strokeDasharray={circumference}
                  strokeDashoffset={circumference - progress}
                  style={{ transition: 'stroke-dashoffset 0.5s linear' }}
                />
              </svg>
              <div className="absolute">
                <p className="text-5xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter">{formatTime(timeLeft)}</p>
              </div>
            </div>
             <div className="flex justify-center space-x-4 mt-4">
                <button onClick={toggleTimer} className={`w-24 font-semibold py-2 px-4 rounded-lg transition-colors ${isActive ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-teal-500 text-white hover:bg-teal-600'}`}>
                    {isActive ? 'Pause' : 'Start'}
                </button>
                <button onClick={resetTimer} className="w-24 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                    Reset
                </button>
            </div>
          </div>
        );
      };

      // =============================================
      // UPDATED MOVIES AND BOOKS COMPONENTS
      // =============================================
      
      const MoviesSection = ({ movies, setMovies, addToArchive }) => {
        const [view, setView] = useState('watched');
        const [showAddForm, setShowAddForm] = useState(false);
        const [newMovie, setNewMovie] = useState({ title: '', status: 'watchlist' });

        const watchedMovies = useMemo(() => movies.filter(m => m.status === 'watched'), [movies]);
        const watchlistMovies = useMemo(() => movies.filter(m => m.status === 'watchlist'), [movies]);

        const addMovie = (e) => {
          e.preventDefault();
          if (!newMovie.title.trim()) return;
          
          const movieToAdd = {
            id: Date.now(),
            title: newMovie.title,
            status: newMovie.status,
            date: new Date().toISOString().split('T')[0],
            lastModified: Date.now()
          };
          
          setMovies(prev => [movieToAdd, ...prev]);
          setNewMovie({ title: '', status: 'watchlist' });
          setShowAddForm(false);
        };

        const markAsWatched = (id) => {
          setMovies(prev => prev.map(movie => 
            movie.id === id ? { ...movie, status: 'watched', lastModified: Date.now() } : movie
          ));
        };

        const markAsWatchlist = (id) => {
          setMovies(prev => prev.map(movie => 
            movie.id === id ? { ...movie, status: 'watchlist', lastModified: Date.now() } : movie
          ));
        };

        // FIXED: Delete movie - COMPLETELY REMOVE from movies
        const deleteMovie = (id) => {
          const movie = movies.find(m => m.id === id);
          if (movie) {
            addToArchive('movie', movie, setMovies);
          }
        };

        const shareList = () => {
          const currentList = view === 'watched' ? watchedMovies : watchlistMovies;
          const listText = currentList.map((movie, index) => 
            `${index + 1}. ${movie.title}`
          ).join('\n');
          
          const shareContent = `${view === 'watched' ? 'Watched Movies' : 'Watchlist'}:\n\n${listText}`;
          
          navigator.clipboard.writeText(shareContent).then(() => {
            alert('List copied to clipboard!');
          }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = shareContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('List copied to clipboard!');
          });
        };

        return (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg text-gray-800 dark:text-white">Movies & Series</h3>
              <div className="flex space-x-2">
                <button onClick={shareList} className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">
                  <ShareIcon />
                </button>
                <button onClick={() => setShowAddForm(true)} className="bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600">
                  <PlusIcon />
                </button>
              </div>
            </div>

            {/* Tabs */}
            <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
              <nav className="-mb-px flex space-x-6">
                <button 
                  onClick={() => setView('watched')} 
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    view === 'watched' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'
                  }`}
                >
                  Watched ({watchedMovies.length})
                </button>
                <button 
                  onClick={() => setView('watchlist')} 
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    view === 'watchlist' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'
                  }`}
                >
                  Watchlist ({watchlistMovies.length})
                </button>
              </nav>
            </div>

            {/* Add Movie Form */}
            {showAddForm && (
              <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40">
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md m-4">
                  <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-4">Add Movie</h3>
                  <form onSubmit={addMovie}>
                    <div className="mb-4">
                      <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Title *</label>
                      <input 
                        type="text" 
                        value={newMovie.title} 
                        onChange={e => setNewMovie(prev => ({ ...prev, title: e.target.value }))}
                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                        required 
                      />
                    </div>
                    <div className="mb-6">
                      <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Status</label>
                      <select 
                        value={newMovie.status}
                        onChange={e => setNewMovie(prev => ({ ...prev, status: e.target.value }))}
                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                      >
                        <option value="watchlist">Watchlist</option>
                        <option value="watched">Watched</option>
                      </select>
                    </div>
                    <div className="flex items-center justify-between">
                      <button type="button" onClick={() => setShowAddForm(false)} className="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                      <button type="submit" className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Add Movie</button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {/* Movie List */}
            <div className="space-y-3">
              {(view === 'watched' ? watchedMovies : watchlistMovies).length === 0 ? (
                <p className="text-center text-gray-400 dark:text-gray-500 py-4">
                  No {view === 'watched' ? 'watched' : 'watchlist'} movies yet.
                </p>
              ) : (
                (view === 'watched' ? watchedMovies : watchlistMovies).map(movie => (
                  <div key={movie.id} className="p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <div className="flex justify-between items-start">
                      <div className="flex-grow">
                        <h4 className="font-semibold text-gray-800 dark:text-white">{movie.title}</h4>
                        <span className="text-sm text-gray-500 dark:text-gray-400">
                          {new Date(movie.date).toLocaleDateString()}
                        </span>
                      </div>
                      <div className="flex space-x-2 ml-2">
                        {view === 'watchlist' ? (
                          <button 
                            onClick={() => markAsWatched(movie.id)}
                            className="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600"
                          >
                            Mark Watched
                          </button>
                        ) : (
                          <button 
                            onClick={() => markAsWatchlist(movie.id)}
                            className="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600"
                          >
                            Move to Watchlist
                          </button>
                        )}
                        <button 
                          onClick={() => deleteMovie(movie.id)}
                          className="text-gray-400 hover:text-red-500"
                        >
                          <DeleteIcon />
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        );
      };

      const BooksSection = ({ books, setBooks, addToArchive }) => {
        const [view, setView] = useState('read');
        const [showAddForm, setShowAddForm] = useState(false);
        const [newBook, setNewBook] = useState({ title: '', author: '', status: 'readlist' });

        const readBooks = useMemo(() => books.filter(b => b.status === 'read'), [books]);
        const readlistBooks = useMemo(() => books.filter(b => b.status === 'readlist'), [books]);

        const addBook = (e) => {
          e.preventDefault();
          if (!newBook.title.trim()) return;
          
          const bookToAdd = {
            id: Date.now(),
            title: newBook.title,
            author: newBook.author,
            status: newBook.status,
            date: new Date().toISOString().split('T')[0],
            lastModified: Date.now()
          };
          
          setBooks(prev => [bookToAdd, ...prev]);
          setNewBook({ title: '', author: '', status: 'readlist' });
          setShowAddForm(false);
        };

        const markAsRead = (id) => {
          setBooks(prev => prev.map(book => 
            book.id === id ? { ...book, status: 'read', lastModified: Date.now() } : book
          ));
        };

        const markAsReadlist = (id) => {
          setBooks(prev => prev.map(book => 
            book.id === id ? { ...book, status: 'readlist', lastModified: Date.now() } : book
          ));
        };

        // FIXED: Delete book - COMPLETELY REMOVE from books
        const deleteBook = (id) => {
          const book = books.find(b => b.id === id);
          if (book) {
            addToArchive('book', book, setBooks);
          }
        };

        const shareList = () => {
          const currentList = view === 'read' ? readBooks : readlistBooks;
          const listText = currentList.map((book, index) => 
            `${index + 1}. "${book.title}" by ${book.author}`
          ).join('\n');
          
          const shareContent = `${view === 'read' ? 'Read Books' : 'Reading List'}:\n\n${listText}`;
          
          navigator.clipboard.writeText(shareContent).then(() => {
            alert('List copied to clipboard!');
          }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = shareContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('List copied to clipboard!');
          });
        };

        return (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg text-gray-800 dark:text-white">Books</h3>
              <div className="flex space-x-2">
                <button onClick={shareList} className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">
                  <ShareIcon />
                </button>
                <button onClick={() => setShowAddForm(true)} className="bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600">
                  <PlusIcon />
                </button>
              </div>
            </div>

            {/* Tabs */}
            <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
              <nav className="-mb-px flex space-x-6">
                <button 
                  onClick={() => setView('read')} 
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    view === 'read' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'
                  }`}
                >
                  Read ({readBooks.length})
                </button>
                <button 
                  onClick={() => setView('readlist')} 
                  className={`py-2 px-1 border-b-2 font-medium text-sm ${
                    view === 'readlist' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'
                  }`}
                >
                  Reading List ({readlistBooks.length})
                </button>
              </nav>
            </div>

            {/* Add Book Form */}
            {showAddForm && (
              <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40">
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md m-4">
                  <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-4">Add Book</h3>
                  <form onSubmit={addBook}>
                    <div className="mb-4">
                      <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Title *</label>
                      <input 
                        type="text" 
                        value={newBook.title} 
                        onChange={e => setNewBook(prev => ({ ...prev, title: e.target.value }))}
                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                        required 
                      />
                    </div>
                    <div className="mb-4">
                      <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Author *</label>
                      <input 
                        type="text" 
                        value={newBook.author} 
                        onChange={e => setNewBook(prev => ({ ...prev, author: e.target.value }))}
                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                        required 
                      />
                    </div>
                    <div className="mb-6">
                      <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Status</label>
                      <select 
                        value={newBook.status}
                        onChange={e => setNewBook(prev => ({ ...prev, status: e.target.value }))}
                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"
                      >
                        <option value="readlist">Reading List</option>
                        <option value="read">Read</option>
                      </select>
                    </div>
                    <div className="flex items-center justify-between">
                      <button type="button" onClick={() => setShowAddForm(false)} className="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                      <button type="submit" className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Add Book</button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {/* Book List */}
            <div className="space-y-3">
              {(view === 'read' ? readBooks : readlistBooks).length === 0 ? (
                <p className="text-center text-gray-400 dark:text-gray-500 py-4">
                  No {view === 'read' ? 'read' : 'reading list'} books yet.
                </p>
              ) : (
                (view === 'read' ? readBooks : readlistBooks).map(book => (
                  <div key={book.id} className="p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <div className="flex justify-between items-start">
                      <div className="flex-grow">
                        <h4 className="font-semibold text-gray-800 dark:text-white">"{book.title}"</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-400">by {book.author}</p>
                        <span className="text-sm text-gray-500 dark:text-gray-400">
                          {new Date(book.date).toLocaleDateString()}
                        </span>
                      </div>
                      <div className="flex space-x-2 ml-2">
                        {view === 'readlist' ? (
                          <button 
                            onClick={() => markAsRead(book.id)}
                            className="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600"
                          >
                            Mark Read
                          </button>
                        ) : (
                          <button 
                            onClick={() => markAsReadlist(book.id)}
                            className="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600"
                          >
                            Move to Reading List
                          </button>
                        )}
                        <button 
                          onClick={() => deleteBook(book.id)}
                          className="text-gray-400 hover:text-red-500"
                        >
                          <DeleteIcon />
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        );
      };

      // FIXED AUTH COMPONENT - Working Google Sign-in
      const AuthComponent = ({ onSignIn, onSkip }) => {
        const [isLoading, setIsLoading] = useState(false);

        const signInWithGoogle = async () => {
          setIsLoading(true);
          try {
            if (auth) {
              const provider = new firebase.auth.GoogleAuthProvider();
              const result = await auth.signInWithPopup(provider);
              console.log('Google sign-in successful:', result.user);
              onSignIn(result.user);
            } else {
              console.log('Firebase auth not available, using test mode');
              const testUser = {
                uid: 'test-user-' + Date.now(),
                displayName: 'Test User',
                email: 'test@example.com',
                photoURL: 'https://placehold.co/96x96/E0E7FF/4F46E5?text=T'
              };
              onSignIn(testUser);
            }
          } catch (error) {
            console.error('Error signing in:', error);
            alert('Firebase not configured. Using test mode.');
            const testUser = {
              uid: 'test-user-' + Date.now(),
              displayName: 'Test User',
              email: 'test@example.com',
              photoURL: 'https://placehold.co/96x96/E0E7FF/4F46E5?text=T'
            };
            onSignIn(testUser);
          } finally {
            setIsLoading(false);
          }
        };

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md m-4 text-center">
              <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Welcome to Mero Jivan</h2>
              <p className="text-gray-600 dark:text-gray-300 mb-6">Sign in to sync your data across devices</p>
              <button
                onClick={signInWithGoogle}
                disabled={isLoading}
                className="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 flex items-center justify-center space-x-3 hover:bg-gray-50 transition-colors disabled:opacity-50"
              >
                <GoogleIcon />
                <span className="text-gray-700 font-medium">
                  {isLoading ? 'Signing in...' : 'Sign in with Google'}
                </span>
              </button>
              <button
                onClick={onSkip}
                className="w-full mt-4 bg-teal-500 text-white rounded-lg py-3 px-4 hover:bg-teal-600 transition-colors"
              >
                Continue without signing in
              </button>
            </div>
          </div>
        );
      };

      // --- VIEWS / SECTIONS ---
      // UPDATED: MoneyView with edit/delete functionality
      const MoneyView = ({ transactions, setTransactions, lendBorrow, setLendBorrow, addToArchive }) => { 
        const [view, setView] = useState('transactions');
        const [displayDate, setDisplayDate] = useState(() => { const today = gregorianToNepali(new Date().toISOString().split('T')[0]); return { year: today.year, month: today.month }; });
        const [isModalOpen, setIsModalOpen] = useState(false); 
        const [modalInitialType, setModalInitialType] = useState('expense'); 
        const [statsFilter, setStatsFilter] = useState('month');
        const [transactionToEdit, setTransactionToEdit] = useState(null);

        const filteredTransactions = useMemo(() => {
            const now = new Date();
            const currentNepali = gregorianToNepali(now.toISOString().split('T')[0]);
            let lastMonthNepaliYear = currentNepali.month === 1 ? currentNepali.year - 1 : currentNepali.year;
            let lastMonthNepaliMonth = currentNepali.month === 1 ? 12 : currentNepali.month - 1;

            if (statsFilter === 'month') {
                return transactions.filter(t => { const d = gregorianToNepali(t.date); return d.year === currentNepali.year && d.month === currentNepali.month });
            }
            if (statsFilter === 'lastMonth') {
                 return transactions.filter(t => { const d = gregorianToNepali(t.date); return d.year === lastMonthNepaliYear && d.month === lastMonthNepaliMonth });
            }
            return transactions;
        }, [transactions, statsFilter]);
        
        const monthlyTransactions = useMemo(() => transactions.filter(t => { const nepaliDate = gregorianToNepali(t.date); return nepaliDate.year === displayDate.year && nepaliDate.month === displayDate.month}), [transactions, displayDate]);
        const { totalIncome, totalExpense, balance } = useMemo(() => { let i = 0, e = 0; monthlyTransactions.forEach(t => t.type === 'income' ? i += t.amount : e += t.amount); return { totalIncome: i, totalExpense: e, balance: i - e }; }, [monthlyTransactions]); 
        const expenseByCategory = useMemo(() => { const map = {}; filteredTransactions.filter(t => t.type === 'expense').forEach(t => { if (!map[t.categoryId]) { const info = ALL_CATEGORIES[t.categoryId] || { name: 'Other', color: '#6C757D' }; map[t.categoryId] = { id: t.categoryId, name: info.name, value: 0, color: info.color }; } map[t.categoryId].value += t.amount; }); return Object.values(map).sort((a, b) => b.value - a.value); }, [filteredTransactions]); 
        
        const openModal = (type) => { 
          setTransactionToEdit(null);
          setModalInitialType(type); 
          setIsModalOpen(true); 
        };
        
        const editTransaction = (transaction) => {
          setTransactionToEdit(transaction);
          setIsModalOpen(true);
        };
        
        // FIXED: Delete transaction - COMPLETELY REMOVE from transactions
        const deleteTransaction = (id) => {
          const transaction = transactions.find(t => t.id === id);
          if (transaction) {
            addToArchive('transaction', transaction, setTransactions);
          }
        };
        
        const addTransaction = (transaction) => { 
          const newTransaction = { ...transaction, lastModified: Date.now() };
          setTransactions(prev => [newTransaction, ...prev]); 
          setIsModalOpen(false); 
        };
        
        const updateTransaction = (updatedTransaction) => {
          setTransactions(prev => prev.map(t => 
            t.id === updatedTransaction.id ? { ...updatedTransaction, lastModified: Date.now() } : t
          ));
          setIsModalOpen(false);
          setTransactionToEdit(null);
        };
        
        const changeMonth = (direction) => { setDisplayDate(p => { let m=p.month+direction, y=p.year; if(m>12){m=1;y++;} if(m<1){m=12;y--;} return NEPALI_MONTH_DATA[y]?{year:y,month:m}:p;}); };
        
        const exportToCsv = () => {
            let csvContent = "data:text/csv;charset=utf-8,Date,Nepali Date,Type,Category,Amount,Description\n";
            transactions.forEach(t => { const nepaliDate = gregorianToNepali(t.date); const categoryName = ALL_CATEGORIES[t.categoryId]?.name || 'N/A'; const description = t.description ? `"${t.description.replace(/"/g, '""')}"` : ''; csvContent += `${t.date},${nepaliDate.year}-${nepaliDate.month}-${nepaliDate.day},${t.type},${categoryName},${t.amount},${description}\n`; });
            const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "transactions.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        return (
          <React.Fragment>
            <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
              <nav className="-mb-px flex space-x-6">
                <button onClick={() => setView('transactions')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'transactions' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Transactions</button>
                <button onClick={() => setView('stats')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'stats' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Stats</button>
                <button onClick={() => setView('lendBorrow')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'lendBorrow' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Lend/Borrow</button>
              </nav>
            </div>

            {view === 'transactions' && (
              <>
                <div className="bg-gradient-to-br from-green-500 to-teal-600 text-white rounded-2xl shadow-lg p-6 mb-6">
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <p className="text-sm opacity-80">Total Balance</p>
                      <p className="text-4xl font-bold tracking-tight">‡§∞‡•Å {balance.toLocaleString('en-NP')}</p>
                    </div>
                    <div className="text-right">
                      <div className="flex items-center justify-end space-x-2">
                        <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-white/20 text-white">&lt;</button>
                        <h2 className="text-md font-semibold text-white">{NEPALI_MONTHS[displayDate.month-1]} {displayDate.year}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-white/20 text-white">&gt;</button>
                      </div>
                    </div>
                  </div>
                  <div className="flex justify-between mt-6 text-sm">
                    <div>
                      <p className="opacity-80">Income</p>
                      <p className="font-semibold">‡§∞‡•Å {totalIncome.toLocaleString('en-NP')}</p>
                    </div>
                    <div className="text-right">
                      <p className="opacity-80">Expense</p>
                      <p className="font-semibold">‡§∞‡•Å {totalExpense.toLocaleString('en-NP')}</p>
                    </div>
                  </div>
                </div>

                <div className="flex space-x-4 mb-6">
                  <button onClick={() => openModal('income')} className="flex-1 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm hover:shadow-md transition-shadow flex items-center justify-center space-x-2">
                    <div className="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><PlusIcon /></div>
                    <p className="font-semibold text-gray-700 dark:text-gray-200">Income</p>
                  </button>
                  <button onClick={() => openModal('expense')} className="flex-1 bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm hover:shadow-md transition-shadow flex items-center justify-center space-x-2">
                    <div className="w-8 h-8 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><MinusIcon /></div>
                    <p className="font-semibold text-gray-700 dark:text-gray-200">Expense</p>
                  </button>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 mb-6">
                  <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-3 px-2">Recent Transactions</h3>
                  <div className="space-y-2 max-h-96 overflow-y-auto pr-2">
                    {monthlyTransactions.length === 0 ? (
                      <p className="text-center text-gray-500 dark:text-gray-400 py-4">No transactions this month.</p>
                    ) : (
                      monthlyTransactions.map(t => {
                        const category = ALL_CATEGORIES[t.categoryId] || {};
                        const nepaliDate = gregorianToNepali(t.date);
                        return (
                          <div key={t.id} className="p-2 rounded-lg flex items-center hover:bg-gray-50 dark:hover:bg-gray-700/50">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${t.type === 'income' ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}`}>
                              {category.Icon && <category.Icon className={`${t.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}/>}
                            </div>
                            <div className="flex-grow">
                              <p className="font-semibold text-gray-800 dark:text-white">{t.description || category.name}</p>
                              <p className="text-sm text-gray-500 dark:text-gray-400">{nepaliDate.day} {nepaliDate.monthName}</p>
                            </div>
                            <p className={`font-bold text-right ${t.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                              {t.type === 'income' ? '+' : '-'} ‡§∞‡•Å {t.amount.toLocaleString('en-NP')}
                            </p>
                            <div className="flex space-x-1 ml-2">
                              <button 
                                onClick={() => editTransaction(t)}
                                className="p-1 text-gray-400 hover:text-blue-500"
                              >
                                <EditIcon />
                              </button>
                              <button 
                                onClick={() => deleteTransaction(t.id)}
                                className="p-1 text-gray-400 hover:text-red-500"
                              >
                                <DeleteIcon />
                              </button>
                            </div>
                          </div>
                        )
                      })
                    )}
                  </div>
                </div>

                <div className="mt-6 text-center">
                  <button onClick={exportToCsv} className="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition-all flex items-center mx-auto space-x-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Export Excel</span>
                  </button>
                </div>
              </>
            )}

            {view === 'stats' && (
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h2 className="text-xl font-bold text-gray-700 dark:text-white mb-4 text-center">Expense Breakdown</h2>
                <div className="flex justify-center my-2">
                  <div className="bg-gray-200 dark:bg-gray-700 rounded-full p-1 flex">
                    <button onClick={() => setStatsFilter('month')} className={`px-3 py-1 text-sm rounded-full ${statsFilter==='month' ? 'bg-white dark:bg-gray-600' : ''}`}>This Month</button>
                    <button onClick={() => setStatsFilter('lastMonth')} className={`px-3 py-1 text-sm rounded-full ${statsFilter==='lastMonth' ? 'bg-white dark:bg-gray-600' : ''}`}>Last Month</button>
                    <button onClick={() => setStatsFilter('all')} className={`px-3 py-1 text-sm rounded-full ${statsFilter==='all' ? 'bg-white dark:bg-gray-600' : ''}`}>All Time</button>
                  </div>
                </div>
                {expenseByCategory.length > 0 ? (
                  <>
                    <PieChart data={expenseByCategory} />
                    <ul className="mt-4 space-y-2">
                      {expenseByCategory.map(cat=>(
                        <li key={cat.id} className="flex items-center justify-between text-sm p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                          <div className="flex items-center">
                            <span className="w-3 h-3 rounded-full mr-3" style={{backgroundColor: cat.color}}></span>
                            <span className="font-medium text-gray-700 dark:text-gray-300">{cat.name}</span>
                          </div>
                          <span className="font-semibold text-gray-800 dark:text-gray-200">‡§∞‡•Å {cat.value.toLocaleString('en-NP')}</span>
                        </li>
                      ))}
                    </ul>
                  </>
                ) : (
                  <p className="text-center text-gray-500 dark:text-gray-400 py-10">No expenses recorded for this period.</p>
                )}
              </div>
            )}

            {view === 'lendBorrow' && <LendBorrowView lendBorrow={lendBorrow} setLendBorrow={setLendBorrow} addToArchive={addToArchive} />}
            <AddTransactionModal 
              isOpen={isModalOpen} 
              onClose={() => {
                setIsModalOpen(false);
                setTransactionToEdit(null);
              }} 
              addTransaction={addTransaction}
              editTransaction={updateTransaction}
              initialType={modalInitialType} 
              transactionToEdit={transactionToEdit}
            />
          </React.Fragment>
        );
      };

      // ENHANCED LIFE VIEW WITH TABS LIKE MONEY SECTION
      const LifeView = ({ todos, setTodos, toBuy, setToBuy, movies, setMovies, books, setBooks, addToArchive }) => { 
        const [view, setView] = useState('pomodoro');

        return (
          <React.Fragment>
            <div className="mb-4 border-b border-gray-200 dark:border-gray-700">
              <nav className="-mb-px flex space-x-6">
                <button onClick={() => setView('pomodoro')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'pomodoro' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Pomodoro</button>
                <button onClick={() => setView('todos')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'todos' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>To-Do List</button>
                <button onClick={() => setView('tobuy')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'tobuy' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>To Buy</button>
                <button onClick={() => setView('movies')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'movies' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Movies</button>
                <button onClick={() => setView('books')} className={`py-2 px-1 border-b-2 font-medium text-sm ${view === 'books' ? 'border-teal-500 text-teal-600 dark:text-teal-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700'}`}>Books</button>
              </nav>
            </div>

            {view === 'pomodoro' && <PomodoroTimerNew />}
            {view === 'todos' && <ToDoList todos={todos} setTodos={setTodos} addToArchive={addToArchive} />}
            {view === 'tobuy' && <ToBuyList toBuy={toBuy} setToBuy={setToBuy} addToArchive={addToArchive} />}
            {view === 'movies' && <MoviesSection movies={movies} setMovies={setMovies} addToArchive={addToArchive} />}
            {view === 'books' && <BooksSection books={books} setBooks={setBooks} addToArchive={addToArchive} />}
          </React.Fragment>
        ); 
      };

      // UPDATED GROWVIEW WITH HABIT TRACKER
      const GrowView = ({ habits, setHabits, addToArchive }) => { 
        return (
          <React.Fragment>
            <HabitTracker habits={habits} setHabits={setHabits} addToArchive={addToArchive} />
            <Stopwatch />
            <BMICalculator />
          </React.Fragment>
        ); 
      };

      // FIXED: LendBorrowView with proper paid/unpaid system
      const LendBorrowView = ({ lendBorrow, setLendBorrow, addToArchive }) => {
          const [type, setType] = useState('lend');
          const [person, setPerson] = useState('');
          const [amount, setAmount] = useState('');
          const [description, setDescription] = useState('');
          const [selectedPerson, setSelectedPerson] = useState('all');
          const [showPaid, setShowPaid] = useState('unpaid'); // 'unpaid', 'paid', 'all'

          const people = useMemo(() => [...new Set(lendBorrow.map(item => item.person))], [lendBorrow]);
          
          // FIXED: Only count UNPAID items in totals
          const { totalLent, totalBorrowed } = useMemo(() => {
              let lent = 0, borrowed = 0;
              lendBorrow.forEach(item => {
                  if (!item.paid) { // ONLY COUNT UNPAID ITEMS
                      if(item.type === 'lend') lent += item.amount;
                      else borrowed += item.amount;
                  }
              });
              return { totalLent: lent, totalBorrowed: borrowed };
          }, [lendBorrow]);

          // Filter data based on paid status
          const filteredData = useMemo(() => {
              let data = lendBorrow;
              
              if (selectedPerson !== 'all') {
                  data = data.filter(item => item.person === selectedPerson);
              }
              
              if (showPaid === 'unpaid') {
                  data = data.filter(item => !item.paid);
              } else if (showPaid === 'paid') {
                  data = data.filter(item => item.paid);
              }
              
              return data;
          }, [lendBorrow, selectedPerson, showPaid]);

          const handleSubmit = (e) => {
              e.preventDefault();
              if (!person || !amount) return;
              setLendBorrow(prev => [{
                  id: Date.now(),
                  type,
                  person,
                  amount: parseFloat(amount),
                  description,
                  date: new Date().toISOString(),
                  lastModified: Date.now(),
                  paid: false // NEW ENTRIES DEFAULT TO UNPAID
              }, ...prev]);
              setPerson('');
              setAmount('');
              setDescription('');
          };

          // Toggle paid status
          const togglePaid = (id) => {
            setLendBorrow(prev => prev.map(item => 
              item.id === id ? { ...item, paid: !item.paid, lastModified: Date.now() } : item
            ));
          };

          // FIXED: Delete entry - COMPLETELY REMOVE from lendBorrow
          const deleteEntry = (id) => {
            const item = lendBorrow.find(i => i.id === id);
            if (item) {
              addToArchive('lendBorrow', item, setLendBorrow);
            }
          };
          
          return (
            <div className="space-y-6">
                {/* Totals Section - ONLY SHOWS UNPAID AMOUNTS */}
                <div className="grid grid-cols-2 gap-4 text-center">
                    <div className="bg-red-100 dark:bg-red-900/50 p-4 rounded-lg">
                        <p className="text-sm text-red-800 dark:text-red-300">You Borrowed (Unpaid)</p>
                        <p className="text-2xl font-bold text-red-600 dark:text-red-400">‡§∞‡•Å {totalBorrowed.toLocaleString('en-NP')}</p>
                    </div>
                    <div className="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg">
                        <p className="text-sm text-green-800 dark:text-green-300">You Lent (Unpaid)</p>
                        <p className="text-2xl font-bold text-green-600 dark:text-green-400">‡§∞‡•Å {totalLent.toLocaleString('en-NP')}</p>
                    </div>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
                     <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">Add New Record</h3>
                     <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="flex gap-2">
                           <button type="button" onClick={() => setType('lend')} className={`flex-1 py-2 rounded-lg font-semibold ${type === 'lend' ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>Lent</button>
                           <button type="button" onClick={() => setType('borrow')} className={`flex-1 py-2 rounded-lg font-semibold ${type === 'borrow' ? 'bg-red-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200'}`}>Borrowed</button>
                        </div>
                        <input type="text" list="people" value={person} onChange={e => setPerson(e.target.value)} placeholder="Person's Name" required className="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        <datalist id="people">
                            {people.map(p => <option key={p} value={p} />)}
                        </datalist>
                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="Amount (‡§∞‡•Å)" required className="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="Description (optional)" className="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        <button type="submit" className="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Add Record</button>
                     </form>
                </div>
                
                {/* History Section with Paid/Unpaid Filter */}
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg text-gray-800 dark:text-white">History</h3>
                        <div className="flex space-x-2">
                            <select value={selectedPerson} onChange={e => setSelectedPerson(e.target.value)} className="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="all">All People</option>
                                {people.map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                            <select value={showPaid} onChange={e => setShowPaid(e.target.value)} className="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="unpaid">Unpaid Only</option>
                                <option value="paid">Paid Only</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>
                    <div className="space-y-2">
                        {filteredData.length === 0 ? <p className="text-center text-gray-500 py-4">No records found.</p> : 
                        [...filteredData].sort((a,b) => b.id - a.id).map(item => (
                            <div key={item.id} className={`p-3 rounded-lg flex justify-between items-center ${item.type === 'lend' ? 'bg-green-50 dark:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/30'} ${item.paid ? 'opacity-60' : ''}`}>
                                <div>
                                    <p className="font-semibold dark:text-white">{item.person}</p>
                                    <p className="text-sm text-gray-600 dark:text-gray-400">{item.description || 'No description'}</p>
                                    {item.paid && <span className="text-xs bg-green-500 text-white px-2 py-1 rounded">Paid</span>}
                                </div>
                                <div className="flex items-center space-x-2">
                                    <p className={`font-bold ${item.type === 'lend' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                        {item.type === 'lend' ? '+' : '-'} ‡§∞‡•Å {item.amount.toLocaleString('en-NP')}
                                    </p>
                                    <button 
                                        onClick={() => togglePaid(item.id)}
                                        className={`p-1 rounded ${item.paid ? 'bg-gray-500 text-white' : 'bg-green-500 text-white'}`}
                                        title={item.paid ? 'Mark as unpaid' : 'Mark as paid'}
                                    >
                                        <CheckIcon />
                                    </button>
                                    <button 
                                        onClick={() => deleteEntry(item.id)}
                                        className="p-1 bg-red-500 text-white rounded"
                                        title="Delete entry"
                                    >
                                        <DeleteIcon />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
          );
      };

      // UPDATED: AccountView with instant local storage clear on logout
      const AccountView = ({ settings, setSettings, clearAllData, isConfirming, setIsConfirming, user, onSignIn, onSignOut }) => {
          const { name, profilePicUrl, theme } = settings;
          const fileInputRef = useRef(null);
          const [showAuth, setShowAuth] = useState(false);

          const handleImageClick = () => fileInputRef.current.click();
          
          const handleFileChange = (e) => {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                      setSettings(prev => ({ ...prev, profilePicUrl: reader.result }));
                  };
                  reader.readAsDataURL(file);
              }
          };

          const removeProfilePicture = () => {
              setSettings(prev => ({ ...prev, profilePicUrl: '' }));
          };
          
          const handleInputChange = (e) => {
              const { name, value } = e.target;
              setSettings(prev => ({ ...prev, [name]: value }));
          };

          const handleThemeChange = (e) => {
              const newTheme = e.target.checked ? 'dark' : 'light';
              setSettings(prev => ({ ...prev, theme: newTheme }));
          };
          
          // FIXED: Instant local storage clear on logout
          const handleSignOut = async () => {
            try {
              if (auth) {
                await auth.signOut();
              }
              
              // Immediately clear ALL local storage
              const keys = [
                'lifeDashboard-settings',
                'lifeDashboard-transactions', 
                'lifeDashboard-todos',
                'lifeDashboard-toBuy',
                'lifeDashboard-lendBorrow',
                'lifeDashboard-movies',
                'lifeDashboard-books',
                'lifeDashboard-habits',
                'lifeDashboard-archive',
                'lifeDashboard-lastModified'
              ];
              
              keys.forEach(key => {
                localStorage.removeItem(key);
              });
              
              console.log('‚úÖ All local storage cleared on logout');
               // INSTANT PAGE REFRESH
              window.location.reload();
                
            } catch (error) {
              console.error('Error signing out:', error);
            }
          };
          
          return (
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-6 space-y-6">
                   {/* Header with app info */}
                   <div className="text-center">
                     <h1 className="text-2xl font-bold text-gray-800 dark:text-white">Hello, {settings.name}</h1>
                     <p className="text-gray-500 dark:text-gray-400 text-sm"><strong>Mero Jivan</strong> by Bidur Bhattarai</p>
                   </div>
                   
                   {/* User Info */}
                   <div className="flex flex-col items-center space-y-4">
                      <div className="relative">
                        <img 
                          src={user?.photoURL || profilePicUrl || `https://placehold.co/96x96/E0E7FF/4F46E5?text=${name.charAt(0)}`} 
                          alt="Profile" 
                          className="w-24 h-24 rounded-full shadow-md object-cover"
                        />
                        <div className="absolute -bottom-1 -right-1 flex space-x-1">
                          <button onClick={handleImageClick} className="bg-teal-500 text-white p-2 rounded-full hover:bg-teal-600">
                            <EditIcon />
                          </button>
                          {profilePicUrl && (
                            <button onClick={removeProfilePicture} className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600">
                              <DeleteIcon />
                            </button>
                          )}
                        </div>
                        <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 text-center">Name</label>
                          <input type="text" name="name" value={name} onChange={handleInputChange} placeholder="Your Name" className="mt-1 text-center text-lg font-semibold shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"/>
                      </div>
                      {user && user.uid !== 'local' ? (
                        <div className="text-center">
                          <p className="text-sm text-gray-600 dark:text-gray-400">Signed in as: {user.email}</p>
                          <button onClick={handleSignOut} className="mt-2 text-sm text-red-500 hover:text-red-600">Sign Out</button>
                        </div>
                      ) : (
                        <div className="text-center">
                          <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">Not signed in</p>
                          <button onClick={() => setShowAuth(true)} className="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600">
                            Sign in to sync data
                          </button>
                        </div>
                      )}
                   </div>

                   {/* Cloud Sync Status */}
                   {user.uid !== 'local' && (
                     <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                       <h4 className="font-semibold text-blue-800 dark:text-blue-300 mb-2">Cloud Sync Status</h4>
                       <p className="text-sm text-blue-700 dark:text-blue-400">
                         ‚úì Signed in as: {user.email}<br/>
                         ‚úì User ID: {user.uid}<br/>
                         ‚úì Firebase: {database ? 'Connected' : 'Not Available'}<br/>
                         ‚úì Real-time sync active across devices<br/>
                         ‚úì Conflict resolution enabled<br/>
                         ‚úì Periodic sync every 30 seconds
                       </p>
                     </div>
                   )}

                   {/* Appearance Settings */}
                   <div>
                       <h3 className="font-semibold text-gray-700 dark:text-gray-300 mb-2">Appearance</h3>
                       <div className="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                           <span className="text-gray-800 dark:text-gray-200">Dark Mode</span>
                           <label className="relative inline-flex items-center cursor-pointer">
                              <input type="checkbox" checked={theme === 'dark'} onChange={handleThemeChange} className="sr-only peer" />
                              <div className="w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                           </label>
                       </div>
                   </div>

                   {/* Data Management */}
                   <div>
                       <h3 className="font-semibold text-gray-700 dark:text-gray-300 mb-2">Data Management</h3>
                       <button onClick={() => setIsConfirming(true)} className="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Clear All App Data</button>
                       {isConfirming && (
                           <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                               <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-sm text-center">
                                   <h4 className="font-bold text-lg text-gray-900 dark:text-white">Are you sure?</h4>
                                   <p className="text-sm text-gray-600 dark:text-gray-300 my-2">This will permanently delete all your app data. This action cannot be undone.</p>
                                   <div className="flex justify-center space-x-4 mt-4">
                                       <button onClick={() => setIsConfirming(false)} className="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                                       <button onClick={clearAllData} className="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Yes, Clear Data</button>
                                   </div>
                               </div>
                           </div>
                       )}
                   </div>

                   {/* Auth Modal */}
                   {showAuth && (
                     <AuthComponent 
                       onSignIn={(user) => { onSignIn(user); setShowAuth(false); }} 
                       onSkip={() => setShowAuth(false)}
                     />
                   )}
              </div>
          );
      };

      // --- MAIN APP COMPONENT ---
      const App = () => {
          const [currentView, setCurrentView] = useState('money'); 
          const [user, setUser] = useState({ uid: 'local', displayName: 'User', email: 'local@user.com' });
          const [showAuth, setShowAuth] = useState(false);
          const [syncStatus, setSyncStatus] = useState('idle');
          const [lastSyncTime, setLastSyncTime] = useState(null);
          
          const useStickyState = (defaultValue, key) => {
              const [value, setValue] = useState(() => {
                  try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                  } catch (e) {
                    return defaultValue;
                  }
              });
              useEffect(() => {
                  try {
                    window.localStorage.setItem(key, JSON.stringify(value));
                  } catch (error) {
                    console.error("Could not save to localStorage", error);
                  }
              }, [key, value]);
              return [value, setValue];
          };

          const [settings, setSettings] = useStickyState({ name: 'User', profilePicUrl: '', theme: 'light' }, 'lifeDashboard-settings');
          const [transactions, setTransactions] = useStickyState([], 'lifeDashboard-transactions');
          const [todos, setTodos] = useStickyState([], 'lifeDashboard-todos');
          const [toBuy, setToBuy] = useStickyState([], 'lifeDashboard-toBuy');
          const [lendBorrow, setLendBorrow] = useStickyState([], 'lifeDashboard-lendBorrow');
          const [movies, setMovies] = useStickyState([], 'lifeDashboard-movies');
          const [books, setBooks] = useStickyState([], 'lifeDashboard-books');
          const [habits, setHabits] = useStickyState([], 'lifeDashboard-habits');
          const [archive, setArchive] = useStickyState([], 'lifeDashboard-archive');
          const [isConfirmingClear, setIsConfirmingClear] = useState(false);
          
          // FIXED: Archive system function - MOVES items instead of copying
          const addToArchive = useCallback((itemType, item, setOriginalState) => {
            const archivedItem = {
              ...item,
              archivedAt: new Date().toISOString(),
              originalType: itemType,
              lastModified: Date.now()
            };
            
            // IMMEDIATELY remove from original array before adding to archive
            if (setOriginalState) {
              setOriginalState(prev => prev.filter(i => i.id !== item.id));
            }
            
            // Add to archive
            setArchive(prev => [archivedItem, ...prev]);
          }, []);

          // Enhanced Auth state listener with proper sync
          useEffect(() => {
            if (auth) {
              const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                console.log('Auth state changed:', firebaseUser);
                
                if (firebaseUser) {
                  setUser(firebaseUser);
                  console.log('User signed in, loading cloud data...');
                  setSyncStatus('loading');
                  
                  // Load data from cloud
                  const cloudData = await loadDataFromCloud(firebaseUser.uid);
                  if (cloudData) {
                    console.log('Applying cloud data to local state with conflict resolution');
                    setSyncStatus('synced');
                    setLastSyncTime(new Date());
                    
                    // Apply cloud data with conflict resolution
                    if (cloudData.transactions) setTransactions(cloudData.transactions);
                    if (cloudData.todos) setTodos(cloudData.todos);
                    if (cloudData.toBuy) setToBuy(cloudData.toBuy);
                    if (cloudData.lendBorrow) setLendBorrow(cloudData.lendBorrow);
                    if (cloudData.movies) setMovies(cloudData.movies);
                    if (cloudData.books) setBooks(cloudData.books);
                    if (cloudData.habits) setHabits(cloudData.habits);
                    if (cloudData.archive) setArchive(cloudData.archive);
                    if (cloudData.settings) {
                      setSettings(prev => ({ ...prev, ...cloudData.settings }));
                    }
                  } else {
                    console.log('No cloud data found, using local data');
                    setSyncStatus('no-data');
                  }

                  // Set up real-time listener for changes from other devices
                  const cleanupListener = setupRealtimeListener(firebaseUser.uid, (cloudData) => {
                    console.log('üîÑ Real-time update received from other device');
                    setSyncStatus('synced');
                    setLastSyncTime(new Date());
                    
                    if (cloudData.transactions) setTransactions(cloudData.transactions);
                    if (cloudData.todos) setTodos(cloudData.todos);
                    if (cloudData.toBuy) setToBuy(cloudData.toBuy);
                    if (cloudData.lendBorrow) setLendBorrow(cloudData.lendBorrow);
                    if (cloudData.movies) setMovies(cloudData.movies);
                    if (cloudData.books) setBooks(cloudData.books);
                    if (cloudData.habits) setHabits(cloudData.habits);
                    if (cloudData.archive) setArchive(cloudData.archive);
                    if (cloudData.settings) {
                      setSettings(prev => ({ ...prev, ...cloudData.settings }));
                    }
                  });

                  return cleanupListener;
                } else {
                  // User signed out - clear local data for security
                  setUser({ uid: 'local', displayName: 'User', email: 'local@user.com' });
                  console.log('User signed out, using local storage only');
                  setSyncStatus('local');
                }
              });
              return () => unsubscribe();
            }
          }, []);

          // Enhanced sync data to cloud when user is signed in and data changes
          useEffect(() => {
            const syncData = async () => {
              if (user && user.uid !== 'local') {
                console.log('Data changed, syncing to cloud...');
                setSyncStatus('syncing');
                const data = {
                  transactions,
                  todos,
                  toBuy,
                  lendBorrow,
                  movies,
                  books,
                  habits,
                  archive,
                  settings,
                  lastSync: new Date().toISOString(),
                  lastSyncBy: 'device_' + Math.random().toString(36).substr(2, 9)
                };
                
                const success = await syncDataToCloud(user.uid, data);
                if (success) {
                  console.log('Cloud sync completed successfully');
                  setSyncStatus('synced');
                  setLastSyncTime(new Date());
                } else {
                  console.log('Cloud sync failed');
                  setSyncStatus('error');
                }
              }
            };

            // Use a timeout to debounce rapid changes
            const timeoutId = setTimeout(syncData, 5000); // 5 second delay
            return () => clearTimeout(timeoutId);
          }, [transactions, todos, toBuy, lendBorrow, movies, books, habits, archive, settings, user]);

          useEffect(() => {
              if (settings.theme === 'dark') {
                  document.documentElement.classList.add('dark');
              } else {
                  document.documentElement.classList.remove('dark');
              }
          }, [settings.theme]);

          const handleSignIn = (userData) => {
            setUser(userData);
            setShowAuth(false);
          };

          const handleSignOut = async () => {
            try {
              if (auth) {
                await auth.signOut();
              }
              setUser({ uid: 'local', displayName: 'User', email: 'local@user.com' });
              setSyncStatus('local');
            } catch (error) {
              console.error('Error signing out:', error);
            }
          };

          const clearAllData = () => {
              window.localStorage.clear();
              window.location.reload();
          };

          // Profile picture component for navigation
          const ProfilePicture = ({ onClick, src, name }) => (
            <button onClick={onClick} className="p-2 rounded-full flex flex-col items-center w-16">
              <img 
                src={src || `https://placehold.co/32x32/E0E7FF/4F46E5?text=${name.charAt(0)}`} 
                alt="Profile" 
                className="w-8 h-8 rounded-full object-cover"
              />
              <span className="text-xs mt-1 text-gray-500 dark:text-gray-400">Account</span>
            </button>
          );

          return (
              <div className="bg-gray-50 dark:bg-gray-900 min-h-screen font-sans flex flex-col">
                  <main className="flex-grow container mx-auto p-4 pb-20">
                      {currentView === 'money' && (
                        <MoneyView 
                          transactions={transactions} 
                          setTransactions={setTransactions} 
                          lendBorrow={lendBorrow} 
                          setLendBorrow={setLendBorrow}
                          addToArchive={addToArchive}
                        />
                      )}
                      {currentView === 'life' && (
                        <LifeView 
                          todos={todos} 
                          setTodos={setTodos} 
                          toBuy={toBuy} 
                          setToBuy={setToBuy}
                          movies={movies}
                          setMovies={setMovies}
                          books={books}
                          setBooks={setBooks}
                          addToArchive={addToArchive}
                        />
                      )}
                      {currentView === 'grow' && (
                        <GrowView 
                          habits={habits}
                          setHabits={setHabits}
                          addToArchive={addToArchive}
                        />
                      )}
                      {currentView === 'account' && (
                        <AccountView 
                          settings={settings} 
                          setSettings={setSettings} 
                          clearAllData={clearAllData} 
                          isConfirming={isConfirmingClear} 
                          setIsConfirming={setIsConfirmingClear}
                          user={user}
                          onSignIn={handleSignIn}
                          onSignOut={handleSignOut}
                        />
                      )}
                  </main>
                  
                  {/* Smaller Navigation Bar */}
                  <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.2)]">
                       <div className="container mx-auto flex justify-around items-center p-2">
                          <button onClick={() => setCurrentView('money')} className={`p-2 rounded-full flex flex-col items-center w-16 ${currentView==='money' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><MoneyIcon /><span className="text-xs mt-1">Money</span></button>
                          <button onClick={() => setCurrentView('life')} className={`p-2 rounded-full flex flex-col items-center w-16 ${currentView==='life' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><LifeIcon /><span className="text-xs mt-1">Life</span></button>
                          <button onClick={() => setCurrentView('grow')} className={`p-2 rounded-full flex flex-col items-center w-16 ${currentView==='grow' ? 'text-teal-600 dark:text-teal-400' : 'text-gray-500 dark:text-gray-400'}`}><GrowIcon /><span className="text-xs mt-1">Grow</span></button>
                          <ProfilePicture 
                            onClick={() => setCurrentView('account')} 
                            src={user.photoURL || settings.profilePicUrl}
                            name={settings.name}
                          />
                      </div>
                  </div>

                  {/* Optional Auth Modal */}
                  {showAuth && (
                    <AuthComponent 
                      onSignIn={handleSignIn}
                      onSkip={() => setShowAuth(false)}
                    />
                  )}
              </div>
          );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
